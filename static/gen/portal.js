var PORTAL=PORTAL||{};PORTAL.queryServices=(function(){"use strict";var self={};self.fetchQueryCounts=function(resultType,queryParamArray,providers){var deferred=$.Deferred();var queryParamJson=PORTAL.UTILS.getQueryParamJson(queryParamArray);var countQueryJson=_.omit(queryParamJson,['mimeType','zip','sorted']);var formatCount=function(countData,key){var countString=_.has(countData,key)?countData[key]:'0';return numeral(countString).format('0,0');};$.ajax({url:Config.QUERY_URLS[resultType]+'/count?mimeType=json',method:'POST',contentType:'application/json',data:JSON.stringify(countQueryJson),success:function(data){var result={total:{sites:formatCount(data,'Total-Site-Count'),results:formatCount(data,'Total-Result-Count')}};_.each(providers,function(provider){result[provider]={sites:formatCount(data,provider+'-Site-Count'),results:formatCount(data,provider+'-Result-Count')};});log.debug('Successfully got counts');deferred.resolve(result);},error:function(jqXHR,textStatus){log.error('Unable to contact the WQP services: '+textStatus);deferred.reject('Unable to contact the WQP services: '+textStatus);}});return deferred.promise();};self.getFormUrl=function(resultType,queryParams){var result=Config.QUERY_URLS[resultType];if(queryParams){result=result+'?'+queryParams;}
return result;};return self;}());var PORTAL=PORTAL||{};PORTAL.UTILS=function(){"use strict";var self={};var COLLAPSE_IMG=Config.STATIC_ENDPOINT+'img/collapse.png';var EXPAND_IMG=Config.STATIC_ENDPOINT+'img/expand.png';self.getQueryString=function(queryParamArray,ignoreList,multiSelectDelimited){var thisIgnoreList=(ignoreList)?ignoreList:[];var resultArray=_.reject(queryParamArray,function(param){return _.contains(thisIgnoreList,param.name);});if(multiSelectDelimited){resultArray=_.chain(resultArray).groupBy('name').map(function(groupedParam,name){return{name:name,value:_.pluck(groupedParam,'value').join(';')};}).value();}
return $.param(resultArray);};self.getQueryParamJson=function(queryParamArray){var result={};_.chain(queryParamArray).groupBy(function(param){return param.name;}).each(function(values,name){result[name]=_.pluck(values,'value');});return result;};self.isExtraSmallBrowser=function(){return $('body').width()<750;};self.setEnabled=function($els,isEnabled ){$els.prop('disabled',!isEnabled);$els.each(function(){var $label=$('label[for="'+$(this).attr('id')+'"]');if(isEnabled){$label.removeClass('disabled');}
else{$label.addClass('disabled');}});};self.toggleShowHideSections=function($button,$contentDiv){var $buttonImg=$button.find('img');if($buttonImg.attr('alt')==='show'){$button.attr('title',$button.attr('title').replace('Show','Hide'));$buttonImg.attr('alt','hide').attr('src',COLLAPSE_IMG);$contentDiv.slideDown();return true;}
else{$button.attr('title',$button.attr('title').replace('Hide','Show'));$buttonImg.attr('alt','show').attr('src',EXPAND_IMG);$contentDiv.slideUp();return false;}};return self;}();var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};(function(){"use strict";var FEATURE_LIMIT=50;var FEATURE_INFO_TEMPLATE=Handlebars.compile('{{#if exceedsFeatureLimit}}'+
'Retrieved {{features.length}} sites, only showing '+FEATURE_LIMIT+'<br />'+
'{{/if}}'+
'{{#each features}}'+
'<br /><table>'+
'<tr><th>Station ID: </th><td class="details-site-id">{{name}}</td></tr>'+
'<tr><th>Name: </th><td>{{locName}}</td></tr>'+
'<tr><th>Type: </th><td>{{type}}</td></tr>'+
'<tr><th>HUC 8: </th><td>{{huc8}}</td></tr>'+
'<tr><th>Org ID: </th><td>{{orgId}}</td></tr>'+
'<tr><th>Org Name: </th><td>{{orgName}}</td></tr>'+
'</table>'+
'{{/each}}');var HIDDEN_FORM_TEMPLATE=Handlebars.compile('{{#if exceedsFeatureLimit}}'+
'<input type="hidden" name="bBox" value="{{boundingBox}}" />'+
'{{#each queryParamArray}}'+
'<input type="hidden" name="{{name}}" value="{{value}}" />'+
'{{/each}}'+
'{{else}}'+
'{{#each features}}'+
'<input type="hidden" name="siteid" value="{{name}}" />'+
'{{/each}}'+
'<input type="hidden" name="zip" checked="checked" id="zip" value="yes"/>'+
'{{/if}}');PORTAL.VIEWS.identifyDialog=function(options){var self={};self.initialize=function(closeActionFnc){var closeFunc=(closeActionFnc)?closeActionFnc:undefined;options.$dialog.find('#download-map-info-button').click(function(){var resultType=options.$dialog.find('input[name="resultType"]:checked').val();var $form=options.$dialog.find('form');var url=Config.QUERY_URLS[resultType];$form.attr('action',url);_gaq.push(['_trackEvent','Portal Page','IdentifyDownload'+resultType,url+'?'+$form.serialize()]);$form.submit();});options.$dialog.dialog({autoOpen:false,modal:false,title:'Detailed site information',width:450,height:400,close:closeFunc});options.$popover.on('hide.bs.popover',closeFunc);};self.showDialog=function(showOptions){var exceedsFeatureLimit=showOptions.features.length>FEATURE_LIMIT;var $detailDiv=options.$dialog.find('#map-info-details-div');var $hiddenFormInputDiv=options.$dialog.find('#map-id-hidden-input-div');var $popover=$('#map-popover');var context={features:showOptions.features,exceedsFeatureLimit:exceedsFeatureLimit,boundingBox:showOptions.boundingBox,queryParamArray:_.reject(showOptions.queryParamArray,function(param){return(param.name==='bBox')||(param.name==='mimeType');})};if(showOptions.usePopover){options.$popover.popover('destroy');if(showOptions.features.length>0){options.$popover.popover({placement:'top',animation:false,content:FEATURE_INFO_TEMPLATE(context),html:true});options.$popover.popover('show');}}
else{if(showOptions.features.length>0){$detailDiv.html(FEATURE_INFO_TEMPLATE(context));$hiddenFormInputDiv.html(HIDDEN_FORM_TEMPLATE(context));options.$dialog.dialog('open');}
else{options.$dialog.dialog('close');}}};return self;};})();var WQP=WQP||{};WQP.MapConfig=(function(){"use strict";var self={};self.DEFAULT_CENTER={lon:-82.5,lat:48.2};self.BASE_LAYER_URL={light_grey_base:{name:'World Light Gray',url:'http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/',attribution:'Esri, HERE, DeLorme, NGA, USGS | Esri, HERE, DeLorme'},world_street:{name:'World Street',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/',attribution:'Esri, HERE, DeLorme, NGA, USGS'},world_imagery:{name:'World Imagery',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/',attribution:'Earthstar Geographics'},world_topo:{name:'World Topo',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/',attribution:'Esri, FAO, NOAA'},world_relief:{name:'World Relief',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/',attribution:'Esri, DeLorme, FAO, NOAA | Copyright:Â© 2014 Esri'}};return self;})();L.control.NldiControl=L.Control.extend({options:{position:'topleft',navChangeHandler:null,distanceChangeHandler:null,clearClickHandler:null},initialize:function(options){"use strict";L.setOptions(this,options);L.Control.prototype.initialize.apply(this,options);this._navSelectEl=undefined;this._distanceInput=undefined;this._clearBtn=undefined;},setNavValue:function(value){"use strict";if(this._navSelectEl){this._navSelectEl.value=value;}},setDistanceValue:function(value){"use strict";if(this._distanceInput){this._distanceInput.value=value;}},onAdd:function(map){"use strict";var container=L.DomUtil.create('div','leaflet-nldi-input-div');this._navSelectEl=L.DomUtil.create('select','leaflet-nldi-nav-picker',container);this._navSelectEl.title='Pick navigation type';this._navSelectEl.innerHTML='<option value="">Select navigation type</option>'+
'<option value="UM">Upstream main</option>'+
'<option value="DM">Downstream main</option>'+
'<option value="UT">Upstream with tributaries</option>'+
'<option value="DD">Downstream with diversions</option>';L.DomEvent.addListener(this._navSelectEl,'change',this.options.navChangeHandler,this);L.DomEvent.disableClickPropagation(this._navSelectEl);this._distanceInput=L.DomUtil.create('input','leaflet-nldi-distance-input',container);this._distanceInput.type='text';this._distanceInput.size='15';this._distanceInput.title='Optional distance from comid';this._distanceInput.placeholder='Distance in km';L.DomEvent.addListener(this._distanceInput,'change',this.options.distanceChangeHandler,this);L.DomEvent.disableClickPropagation(this._distanceInput);this._clearBtn=L.DomUtil.create('button','leaflet-nldi-clear-btn',container);this._clearBtn.type='button';this._clearBtn.title='Reset map';this._clearBtn.innerHTML='<i class="fa fa-undo"></i>';L.DomEvent.addListener(this._clearBtn,'click',this.options.clearClickHandler,this);L.DomEvent.disableClickPropagation(this._clearBtn);return container;},onRemove:function(map){"use strict";L.DomEvent.removeListener(this._navSelectEl,'change',this.options.navChangeHandler);L.DomEvent.removeListener(this._distanceInput,'change',this.options.distanceChangeHandler);L.DomEvent.removeListener(this._clearBtn,'click',this.options.clearClickHandler);}});L.control.nldiControl=function(options){"use strict";return new L.control.NldiControl(options);};L.control.SearchControl=L.Control.extend({options:{position:'topright',zoomToLevel:11},initialize:function(searchAPIEndpoint,options){"use strict";L.setOptions(this,options);L.Control.prototype.initialize.apply(this,options);this.searchAPIEndpoint=searchAPIEndpoint;this.selectControl=undefined;},onAdd:function(map){"use strict";var self=this;var searchResults;var container=L.DomUtil.create('div','leaflet-search-control-div');this.selectControl=L.DomUtil.create('select','leaflet-search-control-input',container);L.DomEvent.disableClickPropagation(this.selectControl);$(this.selectControl).select2({placeholder:'Hint: Type a place and state (e.g. Franklin AZ), zip code, or area code',minimumInputLength:3,ajax:{url:this.searchAPIEndpoint,dataType:'json',delay:500,data:function(params){var terms=params.term.split(' ');var state='';var thisTerm='';if(terms.length>1&&(terms[terms.length-1].length===2)){thisTerm=terms.slice(0,terms.length-1).join(' ');state=terms[terms.length-1];}
else{thisTerm=params.term;}
return{term:thisTerm,state:state,topN:50,LATmin:-90,LATmax:90,LONmin:-180,LONmax:180,includeGNIS:true,includeState:true,includeUsgsSiteSW:false,includeUsgsSiteGW:false,includeUsgsSiteSP:false,includeUsgsSiteAT:false,includeUsgsSiteOT:false,includeZIPcodes:true,includeAREAcodes:true,useCommonGnisClasses:true};},processResults:function(data){var result={};searchResults=data;result.results=data.map(function(el,index){return{id:index,text:el.nm+' '+el.st+' '+el.ct};});return result;}}});L.DomEvent.disableClickPropagation(this.selectControl.nextSibling);$(this.selectControl).on('select2:select',function(ev){var result=searchResults[ev.params.data.id];map.setView(L.latLng(result.y,result.x),self.options.zoomToLevel);ev.target.innerHTML='<option id="'+ev.params.data.id+'" selected>'+ev.params.data.text+'</option>';});return container;},onRemove:function(){"use strict";$(this.selectControl).select2('destroy');}});L.control.searchControl=function(options){"use strict";return new L.control.SearchControl(options);};L.SingleClickEventMixin={dblclickInterval:500,_hasAddedClickHandler:false,_addClickEventHandlers:function(){"use strict";var self=this;var timeout;var clearClickTimeout=function(){if(timeout){clearTimeout(timeout);timeout=undefined;}};var checkLater=function(ev){if(this._singleClickHandlers.length>0){clearTimeout(timeout);timeout=setTimeout(function(){_.each(self._singleClickHandlers,function(handler){handler.boundHandler(ev);});},this.dblclickInterval);}};if(this.on){this.on('click',checkLater);this.on('dblclick',clearClickTimeout);}},addSingleClickHandler:function(handler,context){"use strict";if(!this._hasAddedClickHandler){this._addClickEventHandlers();this._hasAddedClickHandler=true;}
this._singleClickHandlers.push({handler:handler,boundHandler:_.bind(handler,context)});},removeSingleClickHandler:function(handler){"use strict";this._singleClickHandlers=_.reject(this._singleClickHandlers,function(thisHandler){return(thisHandler.handler===handler);});},_singleClickHandlers:[]};var WQP=WQP||{};WQP.ol3=WQP.ol3||{};WQP.ol3.mapUtils=(function(){"use strict";var self={};self.createXYZBaseLayer=function(layerInfo,isVisible){return new ol.layer.Tile({title:layerInfo.name,type:'base',visible:isVisible,source:new ol.source.XYZ({attributions:[new ol.Attribution({html:layerInfo.attribution})],url:layerInfo.url+'{z}/{y}/{x}'})});};self.getEsriHydroLayer=function(isVisible,map){var esriHydroURL='http://hydrology.esri.com/arcgis/rest/services/WorldHydroReferenceOverlay/MapServer/tile/';var hydroTileLayer=new ol.layer.Tile({title:'ESRI Hydro Layer',map:map,visible:isVisible,source:new ol.source.XYZ({url:esriHydroURL+'{z}/{y}/{x}'})});return hydroTileLayer;};self.getNWISSitesLayer=function(wmsParams,layerOptions){var defaultParams={LAYERS:Config.NWIS_SITES_LAYER_NAME,VERSION:'1.1.1',FORMAT:'image/png',TRANSPARENT:true};var defaultLayerOptions={title:'NWIS Stream Gages'};var finalWMSParams=_.extend({},defaultParams,wmsParams);var finalLayerOptions=_.extend({},defaultLayerOptions,layerOptions);var sldDeferred=$.Deferred();var getLayerDeferred=$.Deferred();$.ajax({url:Config.NWIS_SITE_SLD_URL,dataType:'text',success:function(data){finalWMSParams.SLD_BODY=data;sldDeferred.resolve();},error:function(){sldDeferred.resolve();}});sldDeferred.done(function(){var layerSource=new ol.source.TileWMS({params:finalWMSParams,url:Config.NWIS_SITES_OGC_ENDPOINT});finalLayerOptions.source=layerSource;getLayerDeferred.resolve(new ol.layer.Tile(finalLayerOptions));});return getLayerDeferred.promise();};return self;})();var PORTAL=PORTAL||{};PORTAL.MAP=PORTAL.MAP||{};PORTAL.MAP.ToggleControl=function(opt_options){"use strict";var self=this;var options=opt_options||{};var element=document.createElement('div');var button=document.createElement('button');var toggleInteraction=function(e){if(button.className.search('map-toggle-on')!==-1){button.className=button.className.replace('map-toggle-on','map-toggle-off');options.interaction.setActive(false);}
else{button.className=button.className.replace('map-toggle-off','map-toggle-on');options.interaction.setActive(true);}};element.className='map-toggle';button.type='button';button.className='map-toggle-off';button.title=(options.tooltip)?options.tooltip:'';element.appendChild(button);options.interaction.setActive(false);button.addEventListener('click',toggleInteraction);ol.control.Control.call(this,{element:element,target:options.target});};ol.inherits(PORTAL.MAP.ToggleControl,ol.control.Control);var PORTAL=PORTAL||{};PORTAL.MAP=PORTAL.MAP||{};PORTAL.MAP.siteLayer=(function(){"use strict";var self={};var WQP_SITE_LAYER_NAME='wqp_sites';var WFS_VERSION='1.1.0';var getSearchParams=function(queryParamArray){var queryString=PORTAL.UTILS.getQueryString(queryParamArray,['mimeType','zip'],true);var result=decodeURIComponent(queryString.replace(/\+/g,'%20'));return result.replace(/=/g,':').replace(/;/g,'|').replace(/&/g,';');};self.createWQPSitesLayer=function(queryParamArray,wmsParams,layerOptions){var URL=Config.SITES_GEOSERVER_ENDPOINT+'wms';var sourceWMSParams={LAYERS:WQP_SITE_LAYER_NAME,FORMAT:'image/png',TRANSPARENT:true,SEARCHPARAMS:getSearchParams(queryParamArray),VERSION:'1.1.0'};var source=new ol.source.TileWMS({params:_.extend({},wmsParams,sourceWMSParams),url:URL});var siteLayerOptions={title:'WQP Sites',queryParamArray:queryParamArray,visible:true,source:source};source.setProperties({loadingCount:0,loadedCount:0});source.on('tileloadstart',function(){this.setProperties({loadingCount:this.getProperties().loadingCount+1});});source.on('tileloadend',function(){var props=this.getProperties();props.loadedCount=props.loadedCount+1;this.setProperties({loadedCount:props.loadedCount});if(props.loadedCount===props.loadingCount){source.dispatchEvent('sourceloaded');}});source.on('tileloaderror',function(){var props=this.getProperties();props.loadedCount=props.loadedCount+1;this.setProperties({loadedCount:props.loadedCount});if(props.loadedCount===props.loadingCount){source.dispatchEvent('sourceloaded');}});return new ol.layer.Tile(_.extend({},layerOptions,siteLayerOptions));};self.updateWQPSitesLayer=function(layer,queryParamArray){var source=layer.getSource();layer.setProperties({queryParamArray:queryParamArray});source.updateParams({SEARCHPARAMS:getSearchParams(queryParamArray),cacheId:Date.now()});};self.updateWQPSitesSLD=function(layer,sld){layer.getSource().updateParams({STYLES:sld});};self.getWfsGetFeatureUrl=function(queryParamArray){var queryData={request:'GetFeature',service:'wfs',version:WFS_VERSION,typeName:WQP_SITE_LAYER_NAME,searchParams:getSearchParams(queryParamArray),outputFormat:'application/json'};return Config.SITES_GEOSERVER_ENDPOINT+'wfs/?'+$.param(queryData);};self.getWQPSitesFeature=function(queryParamArray,boundingBox){var deferred=$.Deferred();var wfsFormat=new ol.format.WFS();var searchParams=getSearchParams(queryParamArray);var getFeatureDoc;var getFeatureQueryDoc=wfsFormat.writeGetFeature({featureNS:'',featurePrefix:'',featureTypes:[WQP_SITE_LAYER_NAME],srsName:'EPSG:900913',geometryName:'the_geom',bbox:boundingBox});var $getFeature=$(getFeatureQueryDoc);var $filter=$getFeature.find('Filter');$getFeature.remove('BBOX');$getFeature.find('Filter').html('<And><PropertyIsEqualTo matchCase="true">'+
'<PropertyName>searchParams</PropertyName>'+
'<Literal>'+encodeURIComponent(searchParams)+'</Literal>'+
'</PropertyIsEqualTo>'+$filter.html()+'</And>');getFeatureDoc='<GetFeature xmlns="http://www.opengis.net/wfs" '+
'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" service="WFS" version="'+WFS_VERSION+'" '+
'xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd">'+
$(getFeatureQueryDoc).html()+
'</GetFeature>';$.ajax({url:Config.SITES_GEOSERVER_ENDPOINT+'wfs',data:getFeatureDoc,method:'POST',contentType:'application/xml',success:function(response){if($(response).find('ExceptionReport, ows\\:ExceptionReport').length>0){log.error('WFS received an error response');deferred.reject('WFS request failed');}
else{var features=_.map(wfsFormat.readFeatures(response),function(f){return f.getProperties();});deferred.resolve(features);log.debug('Got response');}},error:function(jqXHR,textStatus,error){log.error('Error is '+textStatus);deferred.reject('WFS service is not working');}});return deferred.promise();};self.getLegendGraphicURL=function(wmsSource){var layerParams=wmsSource.getParams();var defaultOptions={REQUEST:'GetLegendGraphic',FORMAT:'image/png',LAYER:layerParams.LAYERS,STYLE:layerParams.STYLES,SEARCHPARAMS:layerParams.SEARCHPARAMS,LEGEND_OPTIONS:'fontStyle:bold;'};return Config.SITES_GEOSERVER_ENDPOINT+'wms?'+$.param(defaultOptions);};return self;})();var PORTAL=PORTAL||{};PORTAL.MAP=PORTAL.MAP||{};PORTAL.MAP.siteMap=function(options){"use strict";var self={};var map;var baseLayerZIndices=[];var wqpSitesLayer;var boxIdSource;var boxDrawInteraction;var boxIdControl;ol.proj.addEquivalentProjections([ol.proj.get('EPSG:900913'),new ol.proj.Projection({code:'http://www.opengis.net/gml/srs/epsg.xml#900913'})]);self.initialize=function(){var worldTopoLayer=WQP.ol3.mapUtils.createXYZBaseLayer(WQP.MapConfig.BASE_LAYER_URL.world_topo,true);var worldStreetLayer=WQP.ol3.mapUtils.createXYZBaseLayer(WQP.MapConfig.BASE_LAYER_URL.world_street,false);var worldReliefLayer=WQP.ol3.mapUtils.createXYZBaseLayer(WQP.MapConfig.BASE_LAYER_URL.world_relief,false);var worldImageryLayer=WQP.ol3.mapUtils.createXYZBaseLayer(WQP.MapConfig.BASE_LAYER_URL.world_imagery,false);var topoZIndex=worldTopoLayer.getZIndex();var streetZIndex=worldStreetLayer.getZIndex();var reliefZIndex=worldReliefLayer.getZIndex();var imageryZIndex=worldImageryLayer.getZIndex();baseLayerZIndices.push(topoZIndex);baseLayerZIndices.push(streetZIndex);baseLayerZIndices.push(reliefZIndex);baseLayerZIndices.push(imageryZIndex);var baseLayerGroup=new ol.layer.Group({title:'Base maps',layers:[worldTopoLayer,worldStreetLayer,worldReliefLayer,worldImageryLayer]});var overlayLayerGroup=new ol.layer.Group({title:'Overlays',layers:[]});var controls=ol.control.defaults().extend([new ol.control.LayerSwitcher({tipLabel:'Switch base layers'}),new ol.control.ScaleLine(),new ol.control.MousePosition({coordinateFormat:function(coordinate){var lonLat=ol.proj.toLonLat(coordinate);return lonLat[0]+', '+lonLat[1];}})]);var boxIdLayer;var worldExtent=ol.extent.applyTransform([-179,-89,179,89],ol.proj.getTransform("EPSG:4326","EPSG:3857"));var pushLayer=function(layer,layerGroup,zIndexAboveBaseLayers){var increment=zIndexAboveBaseLayers?zIndexAboveBaseLayers:1;layer.setZIndex(_.max(baseLayerZIndices)+increment);layerGroup.getLayers().push(layer);};map=new ol.Map({view:new ol.View({center:ol.proj.fromLonLat([WQP.MapConfig.DEFAULT_CENTER.lon,WQP.MapConfig.DEFAULT_CENTER.lat]),zoom:3,minZoom:2,extent:worldExtent}),layers:[overlayLayerGroup,baseLayerGroup],controls:controls});var esriHydroLayer=WQP.ol3.mapUtils.getEsriHydroLayer({isVisible:true,map:map});pushLayer(esriHydroLayer,overlayLayerGroup,1);WQP.ol3.mapUtils.getNWISSitesLayer({},{visible:false,map:map}).done(function(layer){pushLayer(layer,overlayLayerGroup,2);});map.on('singleclick',function(ev){if(wqpSitesLayer&&!boxDrawInteraction.getActive()){var lowerLeft=map.getCoordinateFromPixel([ev.pixel[0]-5,ev.pixel[1]+5]);var upperRight=map.getCoordinateFromPixel([ev.pixel[0]+5,ev.pixel[1]-5]);var boundingBox=[lowerLeft[0],lowerLeft[1],upperRight[0],upperRight[1]];var queryParamArray=wqpSitesLayer.getProperties().queryParamArray;PORTAL.MAP.siteLayer.getWQPSitesFeature(queryParamArray,boundingBox).done(function(resp){options.identifyDialog.showDialog({features:resp,queryParamArray:queryParamArray,boundingBox:ol.proj.transformExtent(boundingBox,'EPSG:900913','EPSG:4326'),usePopover:PORTAL.UTILS.isExtraSmallBrowser()});});}});boxIdSource=new ol.source.Vector({wrapX:false});boxIdSource.on('addfeature',function(){if(wqpSitesLayer){var boundingBox=this.getExtent();var queryParamArray=wqpSitesLayer.getProperties().queryParamArray;PORTAL.MAP.siteLayer.getWQPSitesFeature(queryParamArray,boundingBox).done(function(resp){options.identifyDialog.showDialog({features:resp,queryParamArray:queryParamArray,boundingBox:ol.proj.transformExtent(boundingBox,'EPSG:900913','EPSG:4326'),usePopover:PORTAL.UTILS.isExtraSmallBrowser()});});}});boxIdLayer=new ol.layer.Vector({source:boxIdSource,style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(255, 165, 0, 0.2)'}),stroke:new ol.style.Stroke({color:'rgb(255, 165, 0',width:1})})});map.addLayer(boxIdLayer);boxDrawInteraction=new ol.interaction.Draw({source:boxIdSource,type:'LineString',maxPoints:2,geometryFunction:function(coordinates,geometry){var start=coordinates[0];var end=coordinates[1];if(!geometry){geometry=new ol.geom.Polygon(null);}
geometry.setCoordinates([[start,[start[0],end[1]],end,[end[0],start[1]],start]]);return geometry;}});boxDrawInteraction.on('drawstart',function(){boxIdSource.clear();});boxIdControl=new PORTAL.MAP.ToggleControl({interaction:boxDrawInteraction,tooltip:'Toggle to enable box identify. Click on a point and then move the mouse to the opposite corner of desired area of interest.'});map.addInteraction(boxDrawInteraction);map.addControl(boxIdControl);options.$sldSelect.change(function(){if(wqpSitesLayer){PORTAL.MAP.siteLayer.updateWQPSitesSLD(wqpSitesLayer,options.$sldSelect.val());}});};self.render=function(){if((map)&&(!map.getTarget())){map.setTarget(options.mapDivId);}};self.updateSitesLayer=function(queryParamArray){if(map){options.$loadingIndicator.show();if(wqpSitesLayer){PORTAL.MAP.siteLayer.updateWQPSitesLayer(wqpSitesLayer,queryParamArray);}
else{wqpSitesLayer=PORTAL.MAP.siteLayer.createWQPSitesLayer(queryParamArray,{STYLES:options.$sldSelect.val()},{visible:true,map:map});wqpSitesLayer.getSource().on('sourceloaded',function(){options.$loadingIndicator.hide();options.$legendDiv.html('<img  src="'+PORTAL.MAP.siteLayer.getLegendGraphicURL(wqpSitesLayer.getSource())+'" />');});}}};self.clearBoxIdFeature=function(){if(map){boxIdSource.clear();}};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.createStaticSelect2=function(el,ids,select2Options){"use strict";var defaultOptions={allowClear:true,theme:'bootstrap',data:_.map(ids,function(id){return{id:id,text:id};})};el.select2($.extend({},defaultOptions,select2Options));};PORTAL.VIEWS.createPagedCodeSelect=function(el,spec,select2Options){"use strict";spec.pagesize=(spec.pagesize)?spec.pagesize:20;if(!('formatData'in spec)){spec.formatData=function(data){var desc=(data.hasOwnProperty('desc')&&(data.desc)?data.desc:data.value);return desc+' ('+PORTAL.MODELS.providers.formatAvailableProviders(data.providers)+')';};}
var defaultOptions={allowClear:true,theme:'bootstrap',templateSelection:function(object){return(_.has(object,'id'))?object.id:null;},ajax:{url:Config.CODES_ENDPOINT+'/'+spec.codes,dataType:'json',data:function(params){return{text:params.term,pagesize:spec.pagesize,pagenumber:params.page,mimeType:'json'};},delay:250,processResults:function(data,params){var results=_.map(data.codes,function(code){return{id:code.value,text:spec.formatData(code)};});var page=params.page||1;return{results:results,pagination:{more:((spec.pagesize*page)<data.recordCount)}};}}};el.select2($.extend(defaultOptions,select2Options));};PORTAL.VIEWS.createCodeSelect=function(el,options,select2Options){"use strict";var isMatch;var formatData;var defaultOptions;if(_.has(options,'isMatch')){isMatch=options.isMatch;}
else{isMatch=function(term,lookup){var termMatcher;if(term){termMatcher=new RegExp(term,'i');return termMatcher.test(lookup.desc);}
else{return true;}};}
if(_.has(options,'formatData')){formatData=options.formatData;}
else{formatData=function(data){return{id:data.id,text:data.desc+' ('+PORTAL.MODELS.providers.formatAvailableProviders(data.providers)+')'};};}
defaultOptions={allowClear:true,theme:'bootstrap',matcher:function(term,data){var searchTerm=(_.has(term,'term'))?term.term:'';if(isMatch(searchTerm,options.model.getLookup(data.id))){return data;}
else{return null;}},templateSelection:function(data){var result;if(_.has(data,'id')){result=data.id;}
else{result=null;}
return result;},data:_.map(options.model.getAll(),formatData)};el.select2($.extend(defaultOptions,select2Options));};PORTAL.VIEWS.createCascadedCodeSelect=function(el,options,select2Options){"use strict";var defaultOptions={allowClear:true,theme:'bootstrap'};if(!_.has(options,'isMatch')){options.isMatch=function(term,data){var termMatcher;if(term){termMatcher=new RegExp(term.term,'i');return termMatcher.test(data.id);}
else{return true;}};}
if(!_.has(options,'formatData')){options.formatData=function(data){return{id:data.id,text:data.desc+' ('+PORTAL.MODELS.providers.formatAvailableProviders(data.providers)+')'};};}
defaultOptions.ajax={transport:function(params,success,failure){var deferred=$.Deferred();var modelKeys=options.model.getAllKeys().sort();var selectedKeys=options.getKeys().sort();var filteredLookups;if(_.isEqual(modelKeys,selectedKeys)){filteredLookups=_.filter(options.model.getAll(),function(lookup){return options.isMatch(params.data.term,lookup);});deferred.resolve(filteredLookups);}
else{options.model.fetch(selectedKeys).done(function(data){deferred.resolve(data);}).fail(function(){deferred.reject();});}
deferred.done(success).fail(failure);return deferred.promise();},processResults:function(resp){var result=_.map(resp,function(lookup){return options.formatData(lookup);});return{results:result};}};el.select2($.extend(defaultOptions,select2Options));};var PORTAL=PORTAL||{};$(document).ready(function(){"use strict";if(Config.DEBUG){log.setLevel('debug',false);}
else{log.setLevel('warn',false);}
var $form=$('#params');var downloadProgressDialog=PORTAL.VIEWS.downloadProgressDialog($('#download-status-dialog'));var downloadFormView=PORTAL.VIEWS.downloadFormView({$form:$form,downloadProgressDialog:downloadProgressDialog});var siteMapView=PORTAL.VIEWS.siteMapView({$container:$('#mapping-div'),downloadProgressDialog:downloadProgressDialog,downloadFormView:downloadFormView});var showAPIView=PORTAL.VIEWS.showAPIView({$container:$('#show-queries-div'),getQueryParamArray:downloadFormView.getQueryParamArray});var initDownloadForm=downloadFormView.initialize();siteMapView.initialize();showAPIView.initialize();initDownloadForm.fail(function(){$('#service-error-dialog').modal('show');});});var PORTAL=PORTAL||{};PORTAL.MODELS=PORTAL.MODELS||{};PORTAL.MODELS.providers=function(){"use strict";var ids=[];return{fetch:function(){var deferred=$.Deferred();$.ajax({url:Config.CODES_ENDPOINT+'/providers',data:{mimeType:'json'},type:'GET',success:function(data,textStatus,jqXHR){ids=[];$.each(data.codes,function(index,code){ids.push(code.value);});deferred.resolve();},error:function(jqXHR,textStatus,error){ids=[];log.error('Unable to retrieve provider list with error: '+error);deferred.reject(error);}});return deferred.promise();},getIds:function(){return ids;},formatAvailableProviders:function(availableProviders ){var isValidId=function(id){return _.contains(ids,id);};var availableList=availableProviders.split(' ');var resultList=_.filter(availableList,isValidId);if(resultList.length===ids.length){return'all';}
else{return resultList.join(', ');}}};}();var PORTAL=PORTAL||{};PORTAL.MODELS=PORTAL.MODELS||{};PORTAL.MODELS.cachedCodes=function(options){"use strict";var self={};var cachedData=[];self.fetch=function(){var fetchDeferred=$.Deferred();var URL=Config.CODES_ENDPOINT+'/'+options.codes;$.ajax({url:URL,type:'GET',data:{mimeType:'json'},success:function(data,textStatus,jqXHR){cachedData=_.map(data.codes,function(code){return{id:code.value,desc:(_.has(code,'desc')&&(code.desc))?code.desc:code.value,providers:code.providers};});fetchDeferred.resolve(cachedData);},error:function(jqXHR,textStatus,error){log.error('Can\'t  get '+options.codes+', Server error: '+error);fetchDeferred.reject(error);}});return fetchDeferred.promise();};self.getAll=function(){return cachedData;};self.getLookup=function(id){return _.find(cachedData,function(lookup){return(lookup.id===id);});};return self;};PORTAL.MODELS.codesWithKeys=function(options){"use strict";var self={};var cachedData=[];self.fetch=function(keys){var fetchDeferred=$.Deferred();var URL=Config.CODES_ENDPOINT+'/'+options.codes;$.ajax({url:URL+'?'+options.keyParameter+'='+keys.join(';'),type:'GET',data:{mimeType:'json'},success:function(data,textStatus,jqXHR){cachedData=_.map(keys,function(key){return{key:key,data:_.chain(data.codes).filter(function(lookup){return(options.parseKey(lookup.value)===key);}).map(function(lookup){return{id:lookup.value,desc:(_.has(lookup,'desc')&&(lookup.desc))?lookup.desc:lookup.value,providers:lookup.providers};}).value()};});fetchDeferred.resolve(self.getAll());},error:function(jqXHR,textStatus,error){log.error('Can\'t get '+options.codes+', Server error: '+error);fetchDeferred.reject(error);}});return fetchDeferred.promise();};self.getAll=function(){return _.chain(cachedData).pluck('data').flatten().value();};self.getAllKeys=function(){return _.pluck(cachedData,'key');};self.getDataForKey=function(key){var isMatch=function(object){return object.key===key;};var lookup=_.find(cachedData,isMatch);if(lookup){return lookup.data;}
else{return undefined;}};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.downloadFormView=function(options){"use strict";var self={};var getPlaceInputView=function(){var getCountryFromState=function(id){return(id)?id.split(':')[0]:'';};var getStateFromCounty=function(id){var ids=id.split(':');return(ids.length>1)?ids[0]+':'+ids[1]:'';};var countryModel=PORTAL.MODELS.cachedCodes({codes:'countrycode'});var stateModel=PORTAL.MODELS.codesWithKeys({codes:'statecode',keyParameter:'countrycode',parseKey:getCountryFromState});var countyModel=PORTAL.MODELS.codesWithKeys({codes:'countycode',keyParameter:'statecode',parseKey:getStateFromCounty});return PORTAL.VIEWS.placeInputView({$container:$('#place'),countryModel:countryModel,stateModel:stateModel,countyModel:countyModel});};self.initialize=function(){var placeInputView=getPlaceInputView();var pointLocationInputView=PORTAL.VIEWS.pointLocationInputView({$container:options.$form.find('#point-location')});var boundingBoxInputView=PORTAL.VIEWS.boundingBoxInputView({$container:options.$form.find('#bounding-box')});var siteParameterInputView=PORTAL.VIEWS.siteParameterInputView({$container:options.$form.find('#site-params'),siteTypeModel:PORTAL.MODELS.cachedCodes({codes:'sitetype'}),organizationModel:PORTAL.MODELS.cachedCodes({codes:'organization'})});var nldiView=PORTAL.VIEWS.nldiView({insetMapDivId:'nldi-inset-map',mapDivId:'nldi-map',$inputContainer:options.$form.find('#nldi-param-container')});var samplingParametersInputView=PORTAL.VIEWS.samplingParameterInputView({$container:options.$form.find('#sampling'),sampleMediaModel:PORTAL.MODELS.cachedCodes({codes:'samplemedia'}),characteristicTypeModel:PORTAL.MODELS.cachedCodes({codes:'characteristictype'})});var biologicalSamplingInputView=PORTAL.VIEWS.biologicalSamplingInputView({$container:options.$form.find('#biological'),assemblageModel:PORTAL.MODELS.cachedCodes({codes:'assemblage'})});var dataDetailsView=PORTAL.VIEWS.dataDetailsView({$container:options.$form.find('#download-box-input-div'),updateResultTypeAction:function(resultType){options.$form.attr('action',PORTAL.queryServices.getFormUrl(resultType));}});var initializeProviders=PORTAL.MODELS.providers.fetch().done(function(){PORTAL.VIEWS.createStaticSelect2(options.$form.find('#providers-select'),PORTAL.MODELS.providers.getIds());});var initPlaceInputView=placeInputView.initialize();var initSiteParameterInputView=siteParameterInputView.initialize();var initSamplingParametersInputView=samplingParametersInputView.initialize();var initBiologicalSamplingInputInputView=biologicalSamplingInputView.initialize();var initComplete=$.when(initBiologicalSamplingInputInputView,initializeProviders,initPlaceInputView,initSamplingParametersInputView,initSiteParameterInputView);dataDetailsView.initialize();pointLocationInputView.initialize();boundingBoxInputView.initialize();if(Config.NLDI_ENABLED){nldiView.initialize();}else{options.$form.find('#nldi-container').hide();options.$form.find('#nldi-inset-map').hide();options.$form.find('#nldi-map').hide();}
$('html').click(function(){$('.popover-help').popover('hide');});options.$form.find('.popover-help').each(function(){var options=$.extend({},PORTAL.MODELS.help[($(this).data('help'))],{html:true,trigger:'manual'});$(this).popover(options).click(function(e){$(this).popover('toggle');e.stopPropagation();});});options.$form.find('.panel-heading .show-hide-toggle').click(function(){PORTAL.UTILS.toggleShowHideSections($(this),$(this).parents('.panel').find('.panel-body'));});options.$form.find('.subpanel-heading .show-hide-toggle').click(function(){PORTAL.UTILS.toggleShowHideSections($(this),$(this).parents('.subpanel').find('.subpanel-body'));});options.$form.find('#main-button').click(function(event){var fileFormat=dataDetailsView.getMimeType();var resultType=dataDetailsView.getResultType();var queryParamArray=self.getQueryParamArray();var queryString=decodeURIComponent(PORTAL.UTILS.getQueryString(queryParamArray));var startDownload=function(totalCount){_gaq.push(['_trackEvent','Portal Page',dataDetailsView.getResultType()+'Download',queryString,parseInt(totalCount)]);options.$form.submit();};event.preventDefault();if(!PORTAL.CONTROLLERS.validateDownloadForm(options.$form)){return;}
_gaq.push(['_trackEvent','Portal Page',resultType+'Count',queryString]);options.downloadProgressDialog.show('download');PORTAL.queryServices.fetchQueryCounts(resultType,queryParamArray,PORTAL.MODELS.providers.getIds()).done(function(counts){options.downloadProgressDialog.updateProgress(counts,resultType,fileFormat,startDownload);}).fail(function(message){options.downloadProgressDialog.cancelProgress(message);});});return initComplete;};self.validateDownloadForm=function(){return PORTAL.CONTROLLERS.validateDownloadForm(options.$form);};self.getQueryParamArray=function(){var $formInputs=options.$form.find(':input').not('#mapping-div :input, #nldi-inset-map :input, #nldi-map :input');return _.filter($formInputs.serializeArray(),function(param){return(param.value);});};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.siteMapView=function(options){"use strict";var self={};var STATION_RESULTS='Station';var mapId='query-results-map';var identifyDialog;var portalDataMap;self.initialize=function(){identifyDialog=PORTAL.VIEWS.identifyDialog({$dialog:$('#map-info-dialog'),$popover:options.$container.find('#map-popover')});portalDataMap=PORTAL.MAP.siteMap({mapDivId:mapId,$loadingIndicator:options.$container.find('#map-loading-indicator'),$legendDiv:options.$container.find('#query-map-legend-div .legend-container'),$sldSelect:options.$container.find('#sld-select-input'),identifyDialog:identifyDialog});var $mapContainer=options.$container.find('#query-map-container');var $legendContainer=options.$container.find('#query-map-legend-div');var $map=options.$container.find('#'+mapId);var $showHideBtn=options.$container.find('.show-hide-toggle');$map.height($mapContainer.height());$(window).resize(function(){var mapContainerHeight=$mapContainer.height();if(mapContainerHeight!==$map.height()){$map.height(mapContainerHeight);}});identifyDialog.initialize(portalDataMap.clearBoxIdFeature);portalDataMap.initialize();$showHideBtn.click(function(){var isVisible=PORTAL.UTILS.toggleShowHideSections($(this),$mapContainer);if(isVisible){portalDataMap.render();$legendContainer.show();}
else{$legendContainer.hide();}});options.$container.find('#show-on-map-button').click(function(){var queryParamArray=options.downloadFormView.getQueryParamArray();var queryString=PORTAL.UTILS.getQueryString(queryParamArray);var siteIds=_.filter(queryParamArray,function(param){return param.name==='siteid';});var showMap=function(totalCount){if($mapContainer.is(':hidden')){$showHideBtn.click();}
_gaq.push(['_trackEvent','Portal Map','MapCreate',decodeURIComponent(queryString),parseInt(totalCount)]);portalDataMap.updateSitesLayer(queryParamArray);};if(!options.downloadFormView.validateDownloadForm()){return;}
if(siteIds.length>50){options.downloadProgressDialog.show('map','Unable to map sites. The query contains too many sites to be mapped. Downloads are still available');}
else{_gaq.push(['_trackEvent','Portal Map','MapCount',decodeURIComponent(queryString)]);options.downloadProgressDialog.show('map');PORTAL.queryServices.fetchQueryCounts(STATION_RESULTS,queryParamArray,PORTAL.MODELS.providers.getIds()).done(function(counts){var fileFormat='xml';options.downloadProgressDialog.updateProgress(counts,STATION_RESULTS,fileFormat,showMap);}).fail(function(message){options.downloadProgressDialog.cancelProgress(message);});}});};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.placeInputView=function(options){"use strict";var self={};var USA='US';var initializeCountrySelect=function($select,model){var isMatch=function(searchTerm,lookup){var termMatcher;if(searchTerm){termMatcher=new RegExp(searchTerm,'i');return(termMatcher.test(lookup.id)||(termMatcher.test(lookup.desc)));}
else{return true;}};var templateSelection=function(selectData){if(_.has(selectData,'id')){return selectData.id;}
else{return null;}};var spec={model:model,isMatch:isMatch};PORTAL.VIEWS.createCodeSelect($select,spec,{templateSelection:templateSelection});};var initializeStateSelect=function($select,model,getCountryKeys){var isMatch=function(searchTerm,lookup){var termMatcher;var codes;if(searchTerm){termMatcher=new RegExp(searchTerm,'i');codes=lookup.id.split(':');return(termMatcher.test(lookup.id)||termMatcher.test(lookup.desc)||termMatcher.test(stateFIPS.getPostalCode(codes[1])));}
else{return true;}};var spec={model:model,isMatch:isMatch,getKeys:getCountryKeys};var templateSelection=function(selectData){var codes;var result;if(_.has(selectData,'id')){codes=selectData.id.split(':');if(codes[0]===USA){result=codes[0]+':'+stateFIPS.getPostalCode(codes[1]);}
else{result=selectData.id;}}
else{result=null;}
return result;};PORTAL.VIEWS.createCascadedCodeSelect($select,spec,{templateSelection:templateSelection});};var initializeCountySelect=function($select,model,getStateKeys){var isMatch=function(searchTerm,lookup){var termMatcher;var county;if(searchTerm){termMatcher=new RegExp(searchTerm,'i');county=_.last(lookup.desc.split(','));return termMatcher.test(county);}
else{return true;}};var countySpec={model:model,isMatch:isMatch,getKeys:getStateKeys};var templateSelection=function(selectData){var codes;var result;if(_.has(selectData,'id')){codes=selectData.id.split(':');if(codes[0]==='US'){result=codes[0]+':'+stateFIPS.getPostalCode(codes[1])+':'+codes[2];}
else{result=selectData.id;}}
else{result=null;}
return result;};PORTAL.VIEWS.createCascadedCodeSelect($select,countySpec,{templateSelection:templateSelection});};self.initialize=function(){var $countrySelect=options.$container.find('#countrycode');var $stateSelect=options.$container.find('#statecode');var $countySelect=options.$container.find('#countycode');var fetchCountries=options.countryModel.fetch();var fetchUSStates=options.stateModel.fetch([USA]);var fetchComplete=$.when(fetchCountries,fetchUSStates);options.stateModel.fetch([USA]);var getCountryKeys=function(){var results=$countrySelect.val();return(results)?results:[USA];};var getStateKeys=function(){var results=$stateSelect.val();return(results)?results:[];};fetchCountries.done(function(){initializeCountrySelect($countrySelect,options.countryModel);});initializeStateSelect($stateSelect,options.stateModel,getCountryKeys);initializeCountySelect($countySelect,options.countyModel,getStateKeys);$countrySelect.on('change',function(ev){var countries=$(ev.target).val();var states=$stateSelect.val();var isInCountries=function(state){var countryCode=state.split(':')[0];return _.contains(countries,countryCode);};if(!countries){countries=[USA];}
$stateSelect.val(_.filter(states,isInCountries)).trigger('change');});$stateSelect.on('change',function(ev){var states=$(ev.target).val();var counties=$countySelect.val();var isInStates=function(county){var codes=county.split(':');var stateCode=codes[0]+':'+codes[1];return _.contains(states,stateCode);};$countySelect.val(_.filter(counties,isInStates)).trigger('change');});PORTAL.VIEWS.inputValidation({inputEl:$countySelect,validationFnc:function(val,ev){var result;if(getStateKeys().length===0){ev.preventDefault();result={isValid:false,errorMessage:'Please select at least one state'};}
else{result={isValid:true};}
return result;},event:'select2:opening'});return fetchComplete;};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.pointLocationInputView=function(options){"use strict";var self={};var updateMyLocation=function($lat,$lon){var updateInputs=function(position){$lat.val(position.coords.latitude);$lon.val(position.coords.longitude);};var displayError=function(err){log.error('ERROR('+err.code+'): '+err.message);};navigator.geolocation.getCurrentPosition(updateInputs,displayError,{timeout:8000,maximumAge:60000});return false;};self.initialize=function(){PORTAL.VIEWS.inputValidation({inputEl:options.$container.find('input[type="text"]'),validationFnc:PORTAL.validators.realNumberValidator});if(navigator.geolocation&&navigator.geolocation.getCurrentPosition){var $useMyLocationDiv=options.$container.find('#useMyLocation');var $lat=options.$container.find('#lat');var $lon=options.$container.find('#long');$useMyLocationDiv.html('<button class="btn btn-info" type="button">Use my location</button>');$useMyLocationDiv.find('button').click(function(){updateMyLocation($lat,$lon);});}};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.boundingBoxInputView=function(options){"use strict";var self={};self.initialize=function(){var $textInputs=options.$container.find('input[type="text"]');var $north=options.$container.find('#north');var $south=options.$container.find('#south');var $west=options.$container.find('#west');var $east=options.$container.find('#east');PORTAL.VIEWS.inputValidation({inputEl:$textInputs,validationFnc:PORTAL.validators.realNumberValidator});$textInputs.change(function(){var north=$north.val();var south=$south.val();var east=$east.val();var west=$west.val();var bboxVal='';if((north)&&(south)&&(east)&&(west)){bboxVal=west+','+south+','+east+','+north;}
options.$container.find('input[name="bBox"]').val(bboxVal);});};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.siteParameterInputView=function(options){"use strict";var self={};var initializeOrganizationSelect=function($select,model){var formatData=function(data){return{id:data.id,text:data.id+' - '+data.desc};};var isMatch=function(searchTerm,data){var termMatcher;if(searchTerm){termMatcher=new RegExp(searchTerm,'i');return(termMatcher.test(data.id)||termMatcher.test(data.desc));}
else{return true;}};PORTAL.VIEWS.createCodeSelect($select,{model:model,formatData:formatData,isMatch:isMatch},{minimumInputLength:2,closeOnSelect:false});};self.initialize=function(){var $siteTypeSelect=options.$container.find('#siteType');var $organizationSelect=options.$container.find('#organization');var $siteIdInput=options.$container.find('#siteid');var $hucInput=options.$container.find('#huc');var fetchSiteType=options.siteTypeModel.fetch();var fetchOrganization=options.organizationModel.fetch();var fetchComplete=$.when(fetchSiteType,fetchOrganization);fetchSiteType.done(function(){PORTAL.VIEWS.createCodeSelect($siteTypeSelect,{model:options.siteTypeModel});});fetchOrganization.done(function(){initializeOrganizationSelect($organizationSelect,options.organizationModel);});PORTAL.VIEWS.inputValidation({inputEl:$siteIdInput,validationFnc:PORTAL.validators.siteIdValidator});PORTAL.VIEWS.inputValidation({inputEl:$hucInput,validationFnc:PORTAL.hucValidator.validate,updateFnc:PORTAL.hucValidator.format});return fetchComplete;};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.samplingParameterInputView=function(options){"use strict";var self={};self.initialize=function(){var $sampleMedia=options.$container.find('#sampleMedia');var $characteristicType=options.$container.find('#characteristicType');var $characteristicName=options.$container.find('#characteristicName');var $projectCode=options.$container.find('#project-code');var $minresults=options.$container.find('#minresults');var $startDate=options.$container.find('#startDateLo');var $endDate=options.$container.find('#startDateHi');var fetchSampleMedia=options.sampleMediaModel.fetch();var fetchCharacteristicType=options.characteristicTypeModel.fetch();var fetchComplete=$.when(fetchSampleMedia,fetchCharacteristicType);fetchSampleMedia.done(function(){PORTAL.VIEWS.createCodeSelect($sampleMedia,{model:options.sampleMediaModel});});fetchCharacteristicType.done(function(){PORTAL.VIEWS.createCodeSelect($characteristicType,{model:options.characteristicTypeModel});});PORTAL.VIEWS.createPagedCodeSelect($characteristicName,{codes:'characteristicname'},{closeOnSelect:false});PORTAL.VIEWS.createPagedCodeSelect($projectCode,{codes:'project'},{closeOnSelect:false});PORTAL.VIEWS.inputValidation({inputEl:$minresults,validationFnc:PORTAL.validators.nonNegativeValidator,})
PORTAL.VIEWS.inputValidation({inputEl:$startDate,validationFnc:PORTAL.dateValidator.validate,updateFnc:function(value){return PORTAL.dateValidator.format(value,true);}});PORTAL.VIEWS.inputValidation({inputEl:$endDate,validationFnc:PORTAL.dateValidator.validate,updateFnc:function(value){return PORTAL.dateValidator.format(value,false);}});return fetchComplete;};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.biologicalSamplingInputView=function(options){"use strict";var self={};self.initialize=function(){var $assemblage=options.$container.find('#assemblage');var $taxonomicName=options.$container.find('#subject-taxonomic-name');var fetchAssemblageModel=options.assemblageModel.fetch();var fetchComplete=$.when(fetchAssemblageModel);fetchAssemblageModel.done(function(){PORTAL.VIEWS.createCodeSelect($assemblage,{model:options.assemblageModel});});PORTAL.VIEWS.createPagedCodeSelect($taxonomicName,{codes:'subjecttaxonomicname'},{closeOnSelect:false});return fetchComplete;};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.dataDetailsView=function(options){"use strict";var self={};self.initialize=function(){var $kml=options.$container.find('#kml');var $site=options.$container.find('#sites');var $samples=options.$container.find('#samples');var $biosamples=options.$container.find('#biosamples');var $sorted=options.$container.find('#sorted');var $hiddenSorted=options.$container.find('input[type="hidden"][name="sorted"]');var $mimeTypeRadioboxes=options.$container.find('input[name="mimeType"]');var $resultTypeRadioboxes=options.$container.find('input.result-type');$mimeTypeRadioboxes.change(function(){var kmlChecked=$kml.prop('checked');PORTAL.UTILS.setEnabled($samples,!kmlChecked);PORTAL.UTILS.setEnabled($biosamples,!kmlChecked);});$resultTypeRadioboxes.change(function(){var resultType=$(this).val();var $dataProfile=options.$container.find('input[name="dataProfile"]');options.$container.find('input.result-type:checked').not(this).prop('checked',false);PORTAL.UTILS.setEnabled($kml,$site.prop('checked'));if($biosamples.prop('checked')){if($dataProfile.length===0){options.$container.append('<input type="hidden" name="dataProfile" value="biological" />');}}
else{$dataProfile.remove();}
options.updateResultTypeAction(resultType);});$sorted.change(function(){var val=$(this).is(':checked')?'yes':'no';$hiddenSorted.val(val);});};self.getResultType=function(){return options.$container.find('input.result-type:checked').val();};self.getMimeType=function(){return options.$container.find('input[name="mimeType"]:checked').val();};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.showAPIView=function(options){"use strict";var self={};self.initialize=function(){var $apiQueryDiv=options.$container.find('#api-queries-div');var $sitesText=options.$container.find('#sites-query-div textarea');var $resultsText=options.$container.find('#results-query-div textarea');var $wfsText=options.$container.find('#getfeature-query-div textarea');options.$container.find('#show-queries-button').click(function(){var queryParamArray=options.getQueryParamArray();var queryString=PORTAL.UTILS.getQueryString(queryParamArray);$apiQueryDiv.show();$sitesText.html(PORTAL.queryServices.getFormUrl('Station',queryString));$resultsText.html(PORTAL.queryServices.getFormUrl('Result',queryString));$wfsText.html(PORTAL.MAP.siteLayer.getWfsGetFeatureUrl(queryParamArray));});};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.nldiView=function(options){"use strict";var self={};var huc12='';var pourPtLatLng;var navValue={id:'',text:''};var distanceValue='';var insetMap,map;var $mapDiv=$('#'+options.mapDivId);var $insetMapDiv=$('#'+options.insetMapDivId);var nldiSiteCluster,nldiFlowlineLayers;var insetNldiSiteCluster,insetNldiFlowlineLayers;var getRetrieveMessage=function(){return'<p>Retrieving sites '+navValue.text.toLowerCase()+((distanceValue)?' '+distanceValue+' km':'')+'.</p>';};var cleanUpMaps=function(){if(nldiSiteCluster){nldiSiteCluster.clearLayers();map.removeLayer(nldiSiteCluster);}
if(nldiFlowlineLayers){map.removeLayer(nldiFlowlineLayers);}
if(insetNldiSiteCluster){insetNldiSiteCluster.clearLayers();insetMap.removeLayer(insetNldiSiteCluster);}
if(insetNldiFlowlineLayers){insetMap.removeLayer(insetNldiFlowlineLayers);}
options.$inputContainer.html('');};var updateNldiInput=function(url){var html='';if(url){html='<input type="hidden" name="nldiurl" value="'+url+'" />';}
options.$inputContainer.html(html);};var fetchPourPoint=function(point){var mapBounds=map.getBounds();return $.ajax({url:Config.WQP_MAP_GEOSERVER_ENDPOINT+'wms',method:'GET',data:{version:'1.3.0',request:'GetFeatureInfo',service:'wms',layers:'qw_portal_map:fpp',srs:'EPSG:4326',bbox:mapBounds.getSouth()+','+mapBounds.getWest()+','+mapBounds.getNorth()+','+mapBounds.getEast(),width:map.getSize().x,height:map.getSize().y,'info_format':'application/json','query_layers':'qw_portal_map:fpp',i:point.x,j:point.y}});};var getNldiUrl=function(huc12,navigate,distance){return Config.NLDI_SERVICES_ENDPOINT+'huc12pp/'+huc12+'/navigate/'+navigate+'/wqp?distance='+distance;};var fetchNldiSites=function(huc12,navigate,distance){return $.ajax({url:getNldiUrl(huc12,navigate,distance),method:'GET'});};var fetchNldiFlowlines=function(huc12,navigate,distance){return $.ajax({url:Config.NLDI_SERVICES_ENDPOINT+'huc12pp/'+huc12+'/navigate/'+navigate,method:'GET',data:{distance:distance}});};var updateNldiSites=function(huc12,navigate,distance){var flowlineLayer=_.partial(L.geoJson);var siteLayer=_.partial(L.geoJson,_,{pointToLayer:function(featureData,latlng){return L.circleMarker(latlng,{radius:5,fillColor:"#ff3300",color:"#000",weight:1,opacity:1,fillOpacity:0.8});}});if((huc12)&&(navigate)){$mapDiv.css('cursor','progress');$.when(fetchNldiSites(huc12,navigate,distance),fetchNldiFlowlines(huc12,navigate,distance)).done(function(sitesResponse,flowlinesResponse){var flowlineBounds;var sitesGeojson=sitesResponse[0];var flowlinesGeojson=flowlinesResponse[0];var nldiSiteLayers=siteLayer(sitesGeojson);var insetNldiSiteLayers=siteLayer(sitesGeojson);log.debug('NLDI service has retrieved '+sitesGeojson.features.length+' sites.')
map.closePopup();nldiFlowlineLayers=flowlineLayer(flowlinesGeojson);insetNldiFlowlineLayers=flowlineLayer(flowlinesGeojson);map.addLayer(nldiFlowlineLayers);insetMap.addLayer(insetNldiFlowlineLayers);flowlineBounds=nldiFlowlineLayers.getBounds();map.fitBounds(flowlineBounds);nldiSiteCluster=L.markerClusterGroup({maxClusterRadius:40});insetNldiSiteCluster=L.markerClusterGroup();nldiSiteCluster.addLayer(nldiSiteLayers);insetNldiSiteCluster.addLayer(insetNldiSiteLayers);map.addLayer(nldiSiteCluster);insetMap.addLayer(insetNldiSiteCluster);updateNldiInput(getNldiUrl(huc12,navigate,distance));}).fail(function(){map.openPopup('Unable to retrieve NLDI information',map.getCenter());updateNldiInput('');}).always(function(){$mapDiv.css('cursor','');});}};var findSitesHandler=function(ev){if(navValue.id){log.debug('Clicked at location: '+ev.latlng.toString());$mapDiv.css('cursor','progress');huc12='';pourPtLatLng=undefined;cleanUpMaps();map.closePopup();fetchPourPoint(ev.containerPoint.round()).done(function(result){if(result.features.length===0){map.openPopup('<p>No query point has been selected. Please click on a point to query from.</p>',ev.latlng);$mapDiv.css('cursor','');}
else if(result.features.length>1){map.openPopup('<p>More than one query point has been selected. Please zoom in and try again.</p>',ev.latlng);$mapDiv.css('cursor','');}
else{huc12=result.features[0].properties.HUC_12;pourPtLatLng=ev.latlng;map.openPopup(getRetrieveMessage(),ev.latlng);updateNldiSites(huc12,navValue.id,distanceValue);}}).fail(function(){map.openPopup('<p>Unable to retrieve points, service call failed</p>',ev.latlng);$mapDiv.css('cursor','');});}
else{map.openPopup('<p>Please select a navigation direction</p>',ev.latlng);}};var showMap=function(){if($mapDiv.is(':hidden')){$insetMapDiv.hide();$mapDiv.parent().show();nldiControl.setNavValue(navValue.id);nldiControl.setDistanceValue(distanceValue);map.invalidateSize();map.setView(insetMap.getCenter(),insetMap.getZoom());}
map.closePopup();};var showInsetMap=function(){if($insetMapDiv.is(':hidden')){$insetMapDiv.show();$mapDiv.parent().hide();insetNldiControl.setNavValue(navValue.id);insetNldiControl.setDistanceValue(distanceValue);insetMap.invalidateSize();insetMap.setView(map.getCenter(),map.getZoom());}};var navChangeHandler=function(ev){navValue={id:$(ev.target).val(),text:$(ev.target.selectedOptions[0]).html()};cleanUpMaps();if(navValue.id){showMap();if(huc12){map.openPopup(getRetrieveMessage(),pourPtLatLng);updateNldiSites(huc12,navValue.id,distanceValue);}}
else{huc12='';pourPtLatLng=undefined;showInsetMap();}};var distanceChangeHandler=function(ev){distanceValue=$(ev.target).val();cleanUpMaps();if(navValue.id){showMap();if(huc12){map.openPopup(getRetrieveMessage(),pourPtLatLng);updateNldiSites(huc12,navValue.id,distanceValue);}}
else{showInsetMap();}};var clearHandler=function(){huc12='';pourPtLatLng=undefined;navValue={id:'',text:''};distanceValue='';this.setNavValue(navValue.id);this.setDistanceValue(distanceValue);cleanUpMaps();map.closePopup();};var insetBaseLayers={'World Gray':L.esri.basemapLayer('Gray')};var insetHydroLayer=L.esri.tiledMapLayer({url:"http://hydrology.esri.com/arcgis/rest/services/WorldHydroReferenceOverlay/MapServer"});var baseLayers={'World Gray':L.esri.basemapLayer('Gray'),'World Topo':L.tileLayer.provider('Esri.WorldTopoMap'),'World Street':L.tileLayer.provider('Esri.WorldStreetMap'),'World Relief':L.tileLayer.provider('Esri.WorldShadedRelief'),'World Imagery':L.tileLayer.provider('Esri.WorldImagery')};var hydroLayer=L.esri.tiledMapLayer({url:"http://hydrology.esri.com/arcgis/rest/services/WorldHydroReferenceOverlay/MapServer"});var nhdlPlusFlowlineLayer=L.tileLayer.wms('http://cida.usgs.gov/nwc/geoserver/gwc/service/wms',{layers:'nhdplus:nhdflowline_network',format:'image/png',transparent:true,opacity:0.5});var pourPointLayer=L.tileLayer.wms(Config.WQP_MAP_GEOSERVER_ENDPOINT+'wms',{layers:'fpp',styles:'pour_points',format:'image/png',transparent:true,minZoom:8});var layerSwitcher=L.control.layers(baseLayers,{'Hydro Reference':hydroLayer,'NHDLPlus Flowline Network':nhdlPlusFlowlineLayer,'WBD HU12 Pour Points':pourPointLayer});var insetNldiControl=L.control.nldiControl({navChangeHandler:navChangeHandler,distanceChangeHandler:distanceChangeHandler,clearClickHandler:clearHandler});var nldiControl=L.control.nldiControl({navChangeHandler:navChangeHandler,distanceChangeHandler:distanceChangeHandler,clearClickHandler:clearHandler});var searchControl=L.control.searchControl(Config.GEO_SEARCH_API_ENDPOINT);var expandControl=L.easyButton('fa-lg fa-expand',showMap,'Expand NLDI Map',{position:'topright'});var collapseControl=L.easyButton('fa-lg fa-compress',showInsetMap,'Collapse NLDI Map',{position:'topright'});var MapWithSingleClickHandler=L.Map.extend({includes:L.SingleClickEventMixin});self.initialize=function(){insetMap=L.map(options.insetMapDivId,{center:[37.0,-100.0],zoom:3,layers:[insetBaseLayers['World Gray']],zoomControl:false});insetMap.addLayer(insetHydroLayer);insetMap.addControl(expandControl);insetMap.addControl(insetNldiControl);insetMap.addControl(L.control.zoom());map=new MapWithSingleClickHandler(options.mapDivId,{center:[37.0,-100.0],zoom:3,layers:[baseLayers['World Gray'],hydroLayer,nhdlPlusFlowlineLayer,pourPointLayer],zoomControl:false});map.addControl(searchControl);map.addControl(collapseControl);map.addControl(layerSwitcher);map.addControl(nldiControl);map.addControl(L.control.zoom());map.addSingleClickHandler(findSitesHandler);};return self;};var PORTAL=PORTAL||{};PORTAL.MODELS=PORTAL.MODELS||{};PORTAL.MODELS.help={country:{placement:'auto',title:'Country Help',content:'\
        <div>Countries represented in the database can be selected from the drop down list. \
        The available data sources are listed in parenthesis for each country. Multiple countries\
        may be selected. \
        </div>'},state:{placement:'auto',title:'State Help',content:'\
        <div>States or provinces for the selected countries can be selected from the drop down list. \
        If the countries select is clear, then US states are available. Selections are shown as XX:YY where \
        XX is the country code and YY is the FIPS code with the exception that postal code is shown for US states. \n\
        The available data sources are listed in parenthesis for each state. Multiple states may be selected. \
        </div>'},county:{placement:'auto',title:'County Help',content:'\
        <div>Counties for the selected states can be selected from the drop down list. \
        Selections are shown as XX:YY:ZZZ where XX is the country code, YY is the FIPS or postal code and \
        ZZZ is the county postal code. The available data sources are listed in parenthesis for each county. \
        Multiple counties may be selected.\
        </div>'},pointLocation:{placement:'auto',title:'Point Location Help',content:'\
                <div>Enter a latitude and longitude and a radial distance \
                        to create a search area. Distance should be entered in \
                        miles. Latitude and longitude should be entered in \
                        decimal degrees relative to the NAD83 datum. Longitudes \
                        in the western hemisphere should be preceded with a \
                        negative sign ("-"). Many stations outside the continental US do not have latitude and longitude referenced to WGS84 \
                        and therefore cannot be found using these parameters.\
                </div>\
                <br />\
                <div>\
                        <b>Example:</b>\
                        <br/>\
                        20 miles from Latitude 46.12 degrees N, Longitude 89.15 degrees W would be entered as:\
                        <ul>\
                                <li>Distance: 20</li>\
                                <li>Latitude: 46.12</li>\
                                <li>Longitude: -89.15</li>\
                        </ul>\
                </div>'},boundingBox:{placement:'auto',title:'Bounding Box Help',content:'\
                <div>Enter the North and South latitudes and the East and \
                West longitudes to create a bounding box. Latitude \
                and Longitude should be entered in decimal degrees \
                relative to the NAD83 datum. Longitudes in the \
                western hemisphere should be preceded with a negative sign ("-").\
                </div>\
                <br />\
                <div>\
                <b>Example:</b>\
                <ul>\
                        <li>North: 46.12</li>\
                        <li>East: -89.15</li>\
                        <li>South: 45.93</li>\
                        <li>West: -89.68</li>\
                </ul>\
                </div>'},siteType:{placement:'auto',title:'Site Type Help',content:'\
	        <div>\
	        A site type is a generalized location in the hydrologic cycle, or a man-made \
	        feature thought to affect the hydrologic conditions measured at a site. Site types can be selected \
	        from the drop down list. The available data sources are listed in parenthesis for each \
	        site type. Multiple site types may be selected.\
	        </div>'},organization:{placement:'auto',title:'Organization Help',content:'\
            <div>\
            A designator used to identify a unique business establishment within a context. \
            Select from a list of organization IDs represented in the source databases.\
            Multiple IDs may be selected.\
            </div>'},siteID:{placement:'auto',title:'Site ID Help',content:'\
                <div> \
                A site id is a designator used to describe the unique name, number, or code assigned to identify the monitoring\
                location.  Site IDs are case-sensitive and should be entered in the following format: AGENCY-STATION NUMBER.  More\
                than one site ID may be entered, separated by semicolons.  If you are entering an NWIS site, use "USGS" as the AGENCY.\
                </div>\
                <br />\
                <div>\
                <b>Examples:</b>\
                <ul>\
                        <li><i>For NWIS site:</i> USGS-301650084300701</li>\
                        <li><i>For STORET site:</i> R10BUNKER-CUA005-5</li>\
                        <li><i>For multiple sites:</i><br/> IN002-413354086221001;USSCS-311257091521312;USEPA-414007085591501</li>\
                </ul>\
        </div>\
        <p>For further information about NWIS versus STORET site ids, go to the <a href="../faqs#WQPFAQs-SiteIDs" target="FAQWin">FAQs</a> page</p>'},huc:{placement:'auto',title:'HUC Help',content:'\
                <div>A HUC is a federal code used to identify the hydrologic unit of the monitoring location to the cataloging unit\
                level of precision.  Full hydrologic unit codes (HUCs) or partial HUCs using trailing wildcards may be entered.  Only\
                trailing wildcards are accepted.  More than one HUC may be entered, separated by semicolons.\
                The <A href="http://water.usgs.gov/GIS/huc.html" target="_blank">lists and maps of hydrologic units</A>\
                are available from the USGS.</div>\
                <br />\
                <div>\
                <b>Examples:</b>\
                <ul>\
                        <li>01010003;01010004</li>\
                        <li>010801*</li>\
                        <li>01010003;010801*;01010005</li>\
                </ul>\
                </div>'},nldi:{placement:'auto',title:'NLDI Help',content:'\
			<div><p>Select a navigation direction and distance and click on a query location on the map to display sites upstream or downstream of that point. \
			The list of sites will be passed to the water quality portal query.</p>\
			<p>Use a distance with upstream tributaries to restrict the query size and ensure that the result does not crash the page</p>\
			<p>This tool uses the <a href="https://cida.usgs.gov/nldi/about"  target="_blank" title="Go to the Network Linked Data Index about page" >Network Linked Data Index</a> to navigate.</p>\
			</div>'},sampleMedia:{placement:'auto',title:'Sample Media Help',content:'\
        <div>A sample media indicates the environmental medium where a sample was taken. \
        Sample media can be selected \
        from the drop down list. The available data sources are listed in parenthesis for each \
        sample media. Multiple sample media may be selected.\
        </div>'},characteristicGroup:{placement:'auto',title:'Characteristic Group Help',content:'\
        <div>A characteristic group can be selected \
        from the drop down list. The available data sources are listed in parenthesis for each \
        characteristic group. Multiple characteristic groups may be selected.\
        </div>'},characteristicName:{placement:'auto',title:'Characteristics Help',content:'\
        <div>A characteristic identifies different types of environmental measurements. \
        The names are derived from the USEPA \
        <a href="http://iaspub.epa.gov/sor_internet/registry/substreg/home/overview/home.do" target="_blank">Substance Registry System (SRS)</a>. \
        The available data \
        sources are listed in parenthesis for each characteristic. Multiple characteristics may \
        be selected. </div>'},project:{placement:'auto',title:'Project ID Help',content:'\
    		The Project identifier is a designator used to uniquely identify a data collection project within a context of an organization.'},pcode:{placement:'auto',title:'Parameter Code Help',content:'\
                <div>A Parameter Code is aÂ 5-digit number used inÂ NWISÂ to uniquely identify a specific characteristic. Â \
                One or more five-digit USGS parameter codes can be requested, separated by semicolons. For more information on NWIS \n\
                pcodes see <a target="_blank" href="http://nwis.waterdata.usgs.gov/usa/nwis/pmcodes">http://nwis.waterdata.usgs.gov/usa/nwis/pmcodes</a></div>\
                <br>\
                <div class="instructions"><b>Please Note:</b> Specifying a Parameter Code will limit the query to NWIS only.</div>\
                <br />\
                <div>\
                <b>Examples:</b>\
                <ul>\
                        <li>00065</li>\
                        <li>00065;00010</li>\
                </ul>\
                </div>'},minresults:{placement:'auto',title:'Minimum results per site Help',content:'\
        	<div>This limits the data returned to data from sites where at least a minimum number of results have been \
        	reported that conform to the rest of the query parameters.  For example, if you are looking for stream sites in \
        	Wisconsin that have nutrient samples taken beween 2010 and 2015, entering 10 in this box would return only results \
        	from sites where at least 10 nutrient result values have been reported</div>'},biologicalparams:{placement:'auto',title:'Biological Sampling Parameters Help',content:'\
        	<div>These parameters are related to samples of biological organisms, such as species name or the assemblage that a group of organisms belongs to</div>'},taxonomicName:{placement:'auto',title:'Taxonomic Name Help',content:'\
        	<div>The Taxonomic Name parameter queries the SubjectTaxonomicName in the WQP output.  This is typically in Genus species binomial nomenclature form.  For example, \
        	to look for sites sampled for the shovelnose sturgeon, enter <i>Scaphirhynchus platorynchus</i></div>'},assemblage:{placement:'auto',title:'Assemblage Help',content:'\
    		<div>The Assemblage is specific to biological collection data, and refers to "An association \
    		of interacting populations of organisms in a given waterbody."  Examples include macroinvertabrates and fish/nekton.  </div>'},xmlSchema:{placement:'auto',title:'WQX-Outbound Schema Info',content:'\
                <div>The Water Quality Portal (WQP) \
                        Web Services conform to the format defined in the below referenced XML schema.\
                </div> \
                <br />\
                <div>\
                <b>WQX-Outbound XML schema information:</b>\
                <ul>\
                        <li><a href="schemas/WQX-Outbound/2_0/index.xsd" target="_blank">WQX-Outbound XML schema</a></li>\
                        <li><a href="schemas/WQX-Outbound/2_0/docs/index.html" target="_blank">WQX-Outbound XML schema documentation</a></li>\
                </ul>\
                </div>'}};var stateFIPS={fipsMap:{'01':{name:'Alabama',postalCode:'AL'},'02':{name:'Alaska',postalCode:'AK'},'04':{name:'Arizona',postalCode:'AZ'},'05':{name:'Arkansas',postalCode:'AR'},'06':{name:'California',postalCode:'CA'},'08':{name:'Colorado',postalCode:'CO'},'09':{name:'Connecticut',postalCode:'CT'},'10':{name:'Delaware',postalCode:'DE'},'11':{name:'District of Columbia',postalCode:'DC'},'12':{name:'Florida',postalCode:'FL'},'13':{name:'Georgia',postalCode:'GA'},'15':{name:'Hawaii',postalCode:'HI'},'16':{name:'Idaho',postalCode:'ID'},'17':{name:'Illinois',postalCode:'IL'},'18':{name:'Indiana',postalCode:'IN'},'19':{name:'Iowa',postalCode:'IA'},'20':{name:'Kansas',postalCode:'KS'},'21':{name:'Kentucky',postalCode:'KY'},'22':{name:'Louisiana',postalCode:'LA'},'23':{name:'Maine',postalCode:'ME'},'24':{name:'Maryland',postalCode:'MD'},'25':{name:'Massachusetts',postalCode:'MA'},'26':{name:'Michigan',postalCode:'MI'},'27':{name:'Minnesota',postalCode:'MN'},'28':{name:'Mississippi',postalCode:'MS'},'29':{name:'Missouri',postalCode:'MO'},'30':{name:'Montana',postalCode:'MT'},'31':{name:'Nebraska',postalCode:'NE'},'32':{name:'Nevada',postalCode:'NV'},'33':{name:'New Hampshire',postalCode:'NH'},'34':{name:'New Jersey',postalCode:'NJ'},'35':{name:'New Mexico',postalCode:'NM'},'36':{name:'New York',postalCode:'NY'},'37':{name:'North Carolina',postalCode:'NC'},'38':{name:'North Dakota',postalCode:'ND'},'39':{name:'Ohio',postalCode:'OH'},'40':{name:'Oklahoma',postalCode:'OK'},'41':{name:'Oregon',postalCode:'OR'},'42':{name:'Pennsylvania',postalCode:'PA'},'44':{name:'Rhode Island',postalCode:'RI'},'45':{name:'South Carolina',postalCode:'SC'},'46':{name:'South Dakota',postalCode:'SD'},'47':{name:'Tennessee',postalCode:'TN'},'48':{name:'Texas',postalCode:'TX'},'49':{name:'Utah',postalCode:'UT'},'50':{name:'Vermont',postalCode:'VT'},'51':{name:'Virginia',postalCode:'VA'},'53':{name:'Washington',postalCode:'WA'},'54':{name:'West Virginia',postalCode:'WV'},'55':{name:'Wisconsin',postalCode:'WI'},'56':{name:'Wyoming',postalCode:'WY'},'60':{name:'American Samoa',postalCode:'AS'},'64':{name:'Federated States of Micronesia',postalCode:'FM'},'66':{name:'Guam',postalCode:'GU'},'68':{name:'Marshall Islands',postalCode:'MH'},'69':{name:'Northern Mariana Islands',postalCode:'MP'},'70':{name:'Palau',postalCode:'PW'},'72':{name:'Puerto Rico',postalCode:'PR'},'74':{name:'U.S. Minor Outlying Islands',postalCode:'UM'},'78':{name:'Virgin Islands of the U.S.',postalCode:'VI'}},getPostalCode:function(fips ){if(stateFIPS.fipsMap[fips]){return stateFIPS.fipsMap[fips].postalCode;}
else{return'';}},getName:function(fips ){if(stateFIPS.fipsMap[fips]){return stateFIPS.fipsMap[fips].name;}
else{return'';}},getFromPostalCode:function(postalCode ){for(var fips in stateFIPS.fipsMap){if(stateFIPS.fipsMap[fips].postalCode===postalCode){return fips;}}
return'';}};var PORTAL=PORTAL||{};PORTAL.dateValidator=function(){var DELIM='-';var sepRegExp=new RegExp('/','g');var INVALID={isValid:false,errorMessage:'Dates should be entered as mm-dd-yyyy, mm-yyyy, or yyyy'};var VALID={isValid:true};var that={};that.validate=function(value){var dateValues;var i;if(value){dateValues=value.replace(sepRegExp,'-').split('-');if(dateValues.length>3){return INVALID;}
else
for(i=0;i<dateValues.length;i++){if(!dateValues[i]||isNaN(dateValues[i])){return INVALID;}}
if(dateValues.length===3){if(dateValues[0].length<3&&dateValues[1].length<3&&dateValues[2].length===4){return VALID;}}
else if(dateValues.length===2){if(dateValues[0].length<3&&dateValues[1].length===4){return VALID;}}
else{if(dateValues[0].length===4){return VALID;}}
return INVALID;}
else{return VALID;}};that.format=function(value,isLow){var getZeroFilled=function(n,width){var result=n;var i;if(n.length<width){for(i=0;i<width-n.length;i++){result='0'+result;}}
return result;};var month,day,year;var dateValues;if(value){dateValues=value.replace(sepRegExp,'-').split('-');if(dateValues.length===3){month=getZeroFilled(dateValues[0],2);day=getZeroFilled(dateValues[1],2);year=dateValues[2];}
else if(dateValues.length===2){month=getZeroFilled(dateValues[0],2);year=dateValues[1];if(isLow){day='01';}
else{day=(new Date(year,month,0)).getDate();}}
else if(dateValues.length===1){year=dateValues[0];if(isLow){day='01';month='01';}
else{day='31';month='12';}}
return month+DELIM+day+DELIM+year;}
else{return'';}};return that;}();var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.downloadProgressDialog=function(el){"use strict";var that={};var DIALOG={map:{title:'Map Sites Status',continueMessage:'map the sites',cancelDownload:function(sitesCount){var intSiteCount=parseInt(sitesCount.split(',').join(''));return(intSiteCount>250000);},cancelMessage:'Your query is returning more than 250,000 sites and can not be mapped.'},download:{title:'Download Status',continueMessage:'download the data',cancelDownload:function(counts,fileFormat){return(fileFormat==='xlsx')&&(parseInt(counts.split(',').join(''))>1048575);},cancelMessage:'Your query is returning more than 1,048,575 results which exceeds Excel\'s limit.'}};var opKind;var buttonHtml=function(id,label){return'<button id="'+id+'" type="button" class="btn btn-default">'+label+'</button>';};that.show=function(thisOpKind,dialogMessage){var message=(dialogMessage)?dialogMessage:'Validating query ... Please wait.'
opKind=thisOpKind;el.find('.modal-footer').html('');el.find('.modal-body').html(message);el.find('.modal-header h4').html(DIALOG[opKind].title);el.modal('show');};that.hide=function(){el.modal('hide');};that.updateProgress=function(counts,resultType,fileFormat,continueFnc){var i;var id;var resultsReturned=resultType!=='Station';var totalCount=resultsReturned?counts.total.results:counts.total.sites;var getCountMessage=function(){var message='Your query will return ';var providers=PORTAL.MODELS.providers.getIds();if(resultsReturned){message+='<b>'+counts.total.results+'</b> sample results from <b>'+counts.total.sites+'</b> sites:<br />';for(i=0;i<providers.length;i++){id=providers[i];message+='From '+id+': '+counts[id].results+' sample results from '+counts[id].sites+' sites<br />';}}
else{message+=counts.total.sites+':<br />';for(i=0;i<providers.length;i++){id=providers[i];message+='From '+id+': '+counts[id].sites+'<br/>';}}
return message;};if(totalCount==='0'){that.cancelProgress('Your query returned no data to download.');}
else if(DIALOG[opKind].cancelDownload(totalCount,fileFormat)){that.cancelProgress(getCountMessage()+DIALOG[opKind].cancelMessage);}
else{el.find('.modal-body').html(getCountMessage()+'<p>Click Continue to '+DIALOG[opKind].continueMessage);el.find('.modal-footer').html(buttonHtml('progress-cancel-btn','Cancel')+
buttonHtml('progress-continue-btn','Continue'));$('#progress-cancel-btn').click(function(){el.modal('hide');});$('#progress-continue-btn').click(function(){el.modal('hide');continueFnc(totalCount);});}};that.cancelProgress=function(message){el.find('.modal-body').html(message);el.find('.modal-footer').html(buttonHtml('progress-ok-btn','Ok'));$('#progress-ok-btn').click(function(){el.modal('hide');});};return that;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.inputValidation=function(spec){"use strict";var event=spec.event||'change';spec.inputEl.on(event,function(ev){var inputValue=$(this).val();var result=spec.validationFnc(inputValue,ev);var parent=$(this).parent();parent.find('.error-message').remove();if(result.isValid){parent.removeClass('alert alert-danger');if(spec.updateFnc){$(this).val(spec.updateFnc(inputValue));}}
else{parent.addClass('alert alert-danger');parent.append('<div class="error-message">'+result.errorMessage+'</div>');}});};var PORTAL=PORTAL||{};PORTAL.validators=function(){"use strict";var that={};that.siteIdValidator=function(value){var dashIndex;if(value){dashIndex=value.indexOf('-');if(dashIndex===-1||dashIndex===0||dashIndex===value.length-1){return{isValid:false,errorMessage:'Format is AGENCY-STATION. NWIS sites should use "USGS" as the AGENCY.'};}
else{return{isValid:true};}}
else{return{isValid:true};}};that.realNumberValidator=function(value){if(value){if(isNaN(value)){return{isValid:false,errorMessage:'Enter a floating point number.'};}
else{return{isValid:true};}}
else{return{isValid:true};}};that.nonNegativeValidator=function(value){var result;var MSG="Enter a positive number";if(!value){result={isValid:true,};}
else if(value.match(/^[1-9]\d+$/g)){result={isValid:true};}
else{result={isValid:false,errorMessage:MSG};}
return result;};return that;}();var PORTAL=PORTAL||{};PORTAL.CONTROLLERS=PORTAL.CONTROLLERS||{};PORTAL.CONTROLLERS.validatePointLocation=function(spec){var within=spec.withinEl.val();var lat=spec.latEl.val();var lon=spec.lonEl.val();if((within)&&(lat)&&(lon)){return{isValid:true};}
else if((within)||(lat)||(lon)){return{isValid:false,errorMessage:'In Point Location all parameters must be blank or all parameters must have a non-blank value'};}
else{return{isValid:true};}};PORTAL.CONTROLLERS.validateBoundingBox=function(spec){var north=spec.northEl.val();var south=spec.southEl.val();var east=spec.eastEl.val();var west=spec.westEl.val();if((north)&&(south)&&(east)&&(west)){if(parseFloat(south)>=parseFloat(north)){return{isValid:false,errorMessage:'In Bounding Box, north must be greater than south'};}
else if(parseFloat(west)>=parseFloat(east)){return{isValid:false,errorMessage:'In Bounding Box, east must be greater than west'};}
else{return{isValid:true};}}
else if((north)||(south)||(east)||(west)){return{isValid:false,errorMessage:'In Bounding Box, all parameters must be blank or all must have a non-blank value.'};}
else{return{isValid:true};}};PORTAL.CONTROLLERS.validateDateRange=function(spec){var getDate=function(value){dateArray=value.split('-');return new Date(dateArray[2],dateArray[0]-1,dateArray[1],0,0,0,0);};var fromDateStr=spec.fromDateEl.val();var toDateStr=spec.toDateEl.val();if((fromDateStr)&&(toDateStr)){if(getDate(fromDateStr)<getDate(toDateStr)){return{isValid:true};}
else{return{isValid:false,errorMessage:'From date must be before to date'};}}
else{return{isValid:true};}};PORTAL.CONTROLLERS.validateDownloadForm=function($form){var validateModalEl=$('#validate-download-dialog');var showModal=function(message){validateModalEl.find('.modal-body').html(message);validateModalEl.modal('show');};if($form.find('.error-message').length>0){showModal('Need to correct input validation errors on form');return false;}
var result;result=PORTAL.CONTROLLERS.validatePointLocation({withinEl:$form.find('#within'),latEl:$form.find('#lat'),lonEl:$form.find('#long')});if(!result.isValid){showModal(result.errorMessage);return false;}
result=PORTAL.CONTROLLERS.validateBoundingBox({northEl:$form.find('#north'),southEl:$form.find('#south'),eastEl:$form.find('#east'),westEl:$form.find('#west')});if(!result.isValid){showModal(result.errorMessage);return false;}
result=PORTAL.CONTROLLERS.validateDateRange({fromDateEl:$form.find('#startDateLo'),toDateEl:$form.find('#startDateHi')});if(!result.isValid){showModal(result.errorMessage);return false;}
return true;};var PORTAL=PORTAL||{};PORTAL.hucValidator=function(){var INVALID={isValid:false,errorMessage:'HUCs should be entered as semi-colon separated numbers with 2, 4, 6 or 8 digits with optional \'*\' wildcard'};var VALID={isValid:true};var starReg=/\*$/g;var that={};that.validate=function(value){var i;var thisHuc;var hucArray=value.split(';');for(i=0;i<hucArray.length;i++){if(hucArray[i]){if(hucArray[i].length>8){return INVALID;}
thisHuc=hucArray[i].replace(starReg,'');if(isNaN(thisHuc)){return INVALID;}
if(thisHuc.length!==2&&thisHuc.length!==4&&thisHuc.length!==6&&thisHuc.length!==8){return INVALID;}}}
return VALID;};that.format=function(value){var i;var resultArray=[];var hucArray=value.split(';');for(i=0;i<hucArray.length;i++){if(hucArray[i]){if(hucArray[i].search(starReg)===-1&&hucArray[i].length<8){resultArray.push(hucArray[i]+'*');}
else{resultArray.push(hucArray[i]);}}}
return resultArray.join(';');};return that;}();