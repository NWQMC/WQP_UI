var PORTAL=PORTAL||{};PORTAL.queryServices=(function(){"use strict";var self={};self.fetchHeadRequest=function(resultType,queryParams){var deferred=$.Deferred();var url=self.getFormUrl(resultType,queryParams);if(url.length>2000){deferred.resolve('Too many query criteria selected.  <br>Please reduce your selections <br>'+
'NOTE: selecting all options for a given criteria is the same as selecting none.<br>'+
'query length threshold 2000, current length: '+url.length);}
$.ajax({url:url,method:'HEAD',cache:false,success:function(data,textStatus,jqXHR){deferred.resolve(jqXHR);},error:function(jqXHR,textStatus){log.error('Unable to contact the WQP services: '+textStatus);deferred.resolve('Unable to contact the WQP services: '+textStatus);}});return deferred.promise();};self.getFormUrl=function(resultType,queryParams){return Config.QUERY_URLS[resultType]+"?"+queryParams;};return self;}());var MapUtils={};MapUtils.XYZ_URL_POSTFIX='${z}/${y}/${x}';MapUtils.MERCATOR_PROJECTION=new OpenLayers.Projection("EPSG:900913");MapUtils.WGS84_PROJECTION=new OpenLayers.Projection("EPSG:4326");MapUtils.DEFAULT_CENTER={lon:-82.5,lat:48.2};MapUtils.MAP_OPTIONS={projection:MapUtils.MERCATOR_PROJECTION,maxResolution:156543.0339,maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.ArgParser(),new OpenLayers.Control.Attribution(),new OpenLayers.Control.Zoom(),new OpenLayers.Control.ScaleLine(),new OpenLayers.Control.MousePosition({formatOutput:function(lonLat){lonLat.transform(MapUtils.MERCATOR_PROJECTION,MapUtils.WGS84_PROJECTION);return lonLat.toShortString();}}),new OpenLayers.Control.LayerSwitcher()]};MapUtils.BASE_LAYERS={light_grey_base:{type:OpenLayers.Layer.XYZ,name:'World Light Gray',url:'http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX},world_street:{type:OpenLayers.Layer.XYZ,name:'World Street',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX},world_imagery:{type:OpenLayers.Layer.XYZ,name:'World Imagery',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX},world_topo:{type:OpenLayers.Layer.XYZ,name:'World Topo',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX},world_relief:{type:OpenLayers.Layer.XYZ,name:'World Relief',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX}};MapUtils.getLayer=function(layer,options){if(layer.type==OpenLayers.Layer.Stamen){return new OpenLayers.Layer.Stamen(layer.name,options);}
else{return new layer.type(layer.name,layer.url,options);}}
MapUtils.getNWISSitesLayer=function(options,params){options=options?options:{};params=params?params:{};var defaultOptions={layers:'NWC:gagesII',version:'1.1.1',format:'image/png',transparent:true,tiled:true};var defaultParams={isBaseLayer:false,displayInLayerSwitcher:true,visibility:false,singleTile:true}
var finalParams=$.extend({},defaultParams,params);var finalOptions=$.extend({},defaultOptions,options);var sldDeferred=$.Deferred();$.ajax({url:Config.NWIS_SITE_SLD_URL,dataType:'text',success:function(data){finalOptions.sld_body=data;sldDeferred.resolve(new OpenLayers.Layer.WMS('NWIS Stream Gages','http://cida.usgs.gov/nwc/proxygeoserver/NWC/wms',finalOptions,finalParams));},error:function(){sldDeferred.resolve(new OpenLayers.Layer.WMS('NWIS Stream Gages','http://cida.usgs.gov/nwc/proxygeoserver/NWC/wms',finalOptions,finalParams))}});return sldDeferred;}
var PORTAL=PORTAL||{};PORTAL.UTILS=function(){"use strict";var self={};var COLLAPSE_IMG=Config.STATIC_ENDPOINT+'img/collapse.png';var EXPAND_IMG=Config.STATIC_ENDPOINT+'img/expand.png';self.getQueryString=function(paramArray,ignoreList,multiSelectDelimited){var thisIgnoreList=(ignoreList)?ignoreList:[];var resultArray=_.reject(paramArray,function(param){return _.contains(thisIgnoreList,param.name);});if(multiSelectDelimited){resultArray=_.chain(resultArray).groupBy('name').map(function(groupedParam,name){return{name:name,value:_.pluck(groupedParam,'value').join(';')};}).value();}
return $.param(resultArray);};self.setEnabled=function($els,isEnabled ){$els.prop('disabled',!isEnabled);$els.each(function(){var $label=$('label[for="'+$(this).attr('id')+'"]');if(isEnabled){$label.removeClass('disabled');}
else{$label.addClass('disabled');}});};self.toggleShowHideSections=function($button,$contentDiv){var $buttonImg=$button.find('img');if($buttonImg.attr('alt')==='show'){$button.attr('title',$button.attr('title').replace('Show','Hide'));$buttonImg.attr('alt','hide').attr('src',COLLAPSE_IMG);$contentDiv.slideDown();return true;}
else{$button.attr('title',$button.attr('title').replace('Hide','Show'));$buttonImg.attr('alt','show').attr('src',EXPAND_IMG);$contentDiv.slideUp();return false;}};return self;}();function IdentifyDialog(dialogDivId,downloadUrlFunc ){this.dialogEl=$('#'+dialogDivId);this._downloadButtonEl=this.dialogEl.find('#download-map-info-button');this._detailDivEl=this.dialogEl.find('#map-info-details-div');this.portalDataMap=null;this._downloadButtonEl.click($.proxy(function(){var dialogFormEl=this.dialogEl.find('form');var resultType=this.dialogEl.find('input[name="resultType"]:checked').val();var url=downloadUrlFunc(resultType);var $biosamplesRadio=this.dialogEl.find('#dialog-biosamples');dialogFormEl.attr('action',url);if($biosamplesRadio.prop('checked')){if(dialogFormEl.find('input[name="dataProfile"]').length===0){dialogFormEl.append('<input type="hidden" name="dataProfile" value="biological" />');}}else{this.dialogEl.find('input[name="dataProfile"]').remove();}
_gaq.push(['_trackEvent','Portal Page','IdentifyDownload'+resultType,url+'?'+dialogFormEl.serialize()]);dialogFormEl.submit();},this));this.create=function(portalDataMap){this.portalDataMap=portalDataMap;this.dialogEl.dialog({autoOpen:false,modal:false,title:'Detailed site information',width:450,height:400,close:$.proxy(function(event,ui){this.portalDataMap.cancelIdentifyOp();},this)});};this.updateAndShowDialog=function(siteIds ,bbox ,queryParamArray){var that=this;var updateFnc=function(html){that._detailDivEl.html(html);};var successFnc=function(){var formHtml='';var i;that.dialogEl.find('#map-id-hidden-input-div input[type="hidden"]').remove();if(siteIds.length>50){formHtml+='<input type="hidden" name="bBox" value="'+bbox.toBBOX()+'" />';for(i=0;i<queryParamArray.length;i++){if(queryParamArray[i].name!=='bBox'){formHtml+='<input type="hidden" name="'+queryParamArray[i].name+'" value="'+queryParamArray[i].value+'" />';}}}
else{formHtml+='<input type="hidden" name="siteid" value="'+siteIds.join(';')+'" />';}
that.dialogEl.find('#map-id-hidden-input-div').append(formHtml);that._downloadButtonEl.removeAttr('disabled');};this._downloadButtonEl.attr('disabled','disabled');this.dialogEl.dialog('open');PORTAL.CONTROLLER.retrieveSiteIdInfo(siteIds,updateFnc,successFnc);};}
WQPGetFeature=OpenLayers.Class(OpenLayers.Control.GetFeature,{CLASS_NAME:'WQPGetFeature',selectBoundingBox:new OpenLayers.Bounds(),selectBoxFeatures:[],getLastBoundingBox:function(){return this.selectBoundingBox;},getSelectBoxFeatures:function(){return this.selectBoxFeatures;},initialize:function(options){OpenLayers.Control.GetFeature.prototype.initialize.apply(this,[options]);},selectBox:function(position){if(position instanceof OpenLayers.Bounds){var upperLeftLonLat=this.map.getLonLatFromPixel(new OpenLayers.Pixel(position.left,position.top));var lowerRightLonLat=this.map.getLonLatFromPixel(new OpenLayers.Pixel(position.right,position.bottom));this.selectBoundingBox=new OpenLayers.Bounds(upperLeftLonLat.lon,lowerRightLonLat.lat,lowerRightLonLat.lon,upperLeftLonLat.lat);this.selectBoxFeatures=[new OpenLayers.Feature.Vector(this.selectBoundingBox.toGeometry())];}
else if(!this.click){this.selectBoundingBox=this.pixelToBounds(position);this.selectBoxFeatures=[];}
OpenLayers.Control.GetFeature.prototype.selectBox.apply(this,[position]);},selectClick:function(evt){this.selectBoundingBox=this.pixelToBounds(evt.xy);this.selectBoxFeatures=[];OpenLayers.Control.GetFeature.prototype.selectClick.apply(this,[evt]);}});function SitesLayer(queryParamArray,loadendCallback,enableBoxId,selectFeatureFnc){this._isBoxIDEnabled=enableBoxId;this._selectFeatureFnc=selectFeatureFnc;var getSearchParams=function(queryParamArray){var queryString=PORTAL.UTILS.getQueryString(queryParamArray,['mimeType','zip'],true);var result=decodeURIComponent(queryString.replace(/\+/g,'%20'))
return result.replace(/=/g,':').replace(/;/g,'|').replace(/&/g,';');};this.searchParams=getSearchParams(queryParamArray);this.dataLayer=new OpenLayers.Layer.WMS('Sites',Config.SITES_GEOSERVER_ENDPOINT+'wms',{layers:'wqp_sites',styles:'wqp_sources',format:'image/png',transparent:true,searchParams:this.searchParams},{displayInLayerSwitcher:false,isBaseLayer:false,transitionEffect:'resize',singleTile:true,visibility:true,opacity:0.75,tileOptions:{maxGetUrlLength:1024}});this.dataLayer.events.register('loadend',this,function(ev){loadendCallback();});this._createIdControl=function(){var filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:'searchParams',value:encodeURIComponent(this.searchParams)});var protocol=new OpenLayers.Protocol.WFS({version:'1.1.0',url:Config.SITES_GEOSERVER_ENDPOINT+'wfs',srsName:'EPSG:900913',featureType:'wqp_sites',featureNS:'',featurePrefix:'',defaultFilter:filter});this.idFeatureControl=new WQPGetFeature({protocol:protocol,box:this._isBoxIDEnabled,click:!this._isBoxIDEnabled,clickTolerance:5,single:false,maxFeatures:50});this.idFeatureControl.events.register('featuresselected',this,function(ev){this._selectFeatureFnc(ev,this.idFeatureControl.getLastBoundingBox());});this.idFeatureControl.events.register('clickout',this,function(ev){console.log('No feature selected');});};this.idFeatureControl=null;this.addToMap=function(map ){map.addLayer(this.dataLayer);this._createIdControl();map.addControl(this.idFeatureControl);this.idFeatureControl.activate();};this.removeFromMap=function(map ){this.idFeatureControl.deactivate();map.removeControl(this.idFeatureControl);map.removeLayer(this.dataLayer);};this.enableBoxId=function(map ,on ){if(this._isBoxIDEnabled!==on){this._isBoxIDEnabled=on;this.idFeatureControl.deactivate();map.removeControl(this.idFeatureControl);this._createIdControl();map.addControl(this.idFeatureControl);this.idFeatureControl.activate();}};};SiteImportWPSUtils={getRequestXML:function(identifier ,dataInputs ){var formattedData=[];for(var i=0;i<dataInputs.length;i++){formattedData.push({'identifier':dataInputs[i].name,'data':{'literalData':{'value':dataInputs[i].value}}});}
return new OpenLayers.Format.WPSExecute().write({'identifier':identifier,'dataInputs':formattedData,'responseForm':{'rawDataOutput':{'identifier':'result'}}});}}
function PortalDataMap(mapDivId,identifyDialog ){var WPS_URL=Config.GEOSERVER_ENDPOINT+'/ows?service=WPS&version=1.0.0&request=Execute';var BASE_LAYERS=['world_topo','world_street','world_relief','world_imagery'];this.map=new OpenLayers.Map(mapDivId,MapUtils.MAP_OPTIONS);this.identifyTool=new OpenLayers.Control.Button({displayClass:'identify-button',type:OpenLayers.Control.TYPE_TOGGLE,title:'Toggle to enable box identify. Click and drag to draw rectangle area of interest.',eventListeners:{activate:function(){this._boxIdentifyOn=true;this.toggleBoxId();},deactivate:function(){this._boxIdentifyOn=false;this.toggleBoxId();},scope:this}});this.toolPanel=new OpenLayers.Control.Panel({createControlMarkup:function(control){var button=document.createElement('button');return button;}});this.toolPanel.addControls([this.identifyTool]);this.map.addControl(this.toolPanel);this.dataLayer=null;this._boxIdentifyOn=false;this._identifyDialog=identifyDialog;this._popupIdentify;this._selectBoxLayer=new OpenLayers.Layer.Vector('selectBoxLayer',{displayInLayerSwitcher:false,isBaseLayer:false});this.map.addLayer(this._selectBoxLayer);this._updateSelectBoxLayer=function(){this._selectBoxLayer.destroyFeatures();this._selectBoxLayer.addFeatures(this.dataLayer.idFeatureControl.getSelectBoxFeatures());};this._identifyDialog.create(this);OpenLayers.ProxyHost=""
var loadingPanel=new OpenLayers.Control.LoadingPanel();this.map.addControl(loadingPanel);var baseLayers=[];for(var i=0;i<BASE_LAYERS.length;i++){baseLayers[i]=MapUtils.getLayer(MapUtils.BASE_LAYERS[BASE_LAYERS[i]],{isBaseLayer:true,transitionEffect:'resize'});}
this.map.addLayers(baseLayers);MapUtils.getNWISSitesLayer().then(function(layer){this.map.addLayer(layer);}.bind(this));this.map.zoomTo(3);var center=new OpenLayers.LonLat(MapUtils.DEFAULT_CENTER.lon,MapUtils.DEFAULT_CENTER.lat);this.map.setCenter(center.transform(MapUtils.WGS84_PROJECTION,MapUtils.MERCATOR_PROJECTION));this.toggleBoxId=function(){if(this.dataLayer){this.dataLayer.enableBoxId(this.map,this._boxIdentifyOn);}};this.cancelIdentifyOp=function(){this._selectBoxLayer.destroyFeatures();};this.showDataLayer=function(queryParamArray,loadendCallback){var self=this;if(this.dataLayer){this.dataLayer.removeFromMap(this.map);this._selectBoxLayer.destroyFeatures();this.map.removeLayer(this._selectBoxLayer);}
if(this._identifyDialog.dialogEl.dialog('isOpen')){this._identifyDialog.dialogEl.dialog('close');}
if(this._popupIdentify){this.map.removePopup(this._popupIdentify);}
this.dataLayer=new SitesLayer(queryParamArray,loadendCallback,this._boxIdentifyOn,function(ev,selectBoundingBox){var siteIds=[];var degreeBBox;var i;self._updateSelectBoxLayer();for(i=0;i<ev.features.length;i++){siteIds.push(ev.features[i].attributes.name);}
if($('body').width()<750){PORTAL.CONTROLLER.retrieveSiteIdInfo(siteIds,function(html){this._popupIdentify=new OpenLayers.Popup.FramedCloud('idPopup',selectBoundingBox.getCenterLonLat(),null,html,null,true,function(){self._popupIdentify=null;self.cancelIdentifyOp();self.destroy();});self.map.addPopup(this._popupIdentify,true);});}
else{degreeBBox=selectBoundingBox.transform(MapUtils.MERCATOR_PROJECTION,MapUtils.WGS84_PROJECTION);self._identifyDialog.updateAndShowDialog(siteIds,degreeBBox,queryParamArray);}});this.dataLayer.addToMap(this.map);this.map.addLayer(this._selectBoxLayer);};};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.createStaticSelect2=function(el,ids,select2Options){"use strict";var defaultOptions={allowClear:true,theme:'bootstrap',data:_.map(ids,function(id){return{id:id,text:id};})};el.select2($.extend({},defaultOptions,select2Options));};PORTAL.VIEWS.createPagedCodeSelect=function(el,spec,select2Options){"use strict";spec.pagesize=(spec.pagesize)?spec.pagesize:20;if(!('formatData'in spec)){spec.formatData=function(data){var desc=(data.hasOwnProperty('desc')&&(data.desc)?data.desc:data.value);return desc+' ('+PORTAL.MODELS.providers.formatAvailableProviders(data.providers)+')';};}
var defaultOptions={allowClear:true,theme:'bootstrap',templateSelection:function(object){return(_.has(object,'id'))?object.id:null;},ajax:{url:Config.CODES_ENDPOINT+'/'+spec.codes,dataType:'json',data:function(params){return{text:params.term,pagesize:spec.pagesize,pagenumber:params.page,mimeType:'json'};},delay:250,processResults:function(data,params){var results=_.map(data.codes,function(code){return{id:code.value,text:spec.formatData(code)};});return{results:results,more:((spec.pagesize*params.page)<data.recordCount)};}}};el.select2($.extend(defaultOptions,select2Options));};PORTAL.VIEWS.createCodeSelect=function(el,options,select2Options){"use strict";var isMatch;var formatData;var defaultOptions;if(_.has(options,'isMatch')){isMatch=options.isMatch;}
else{isMatch=function(term,lookup){var termMatcher;if(term){termMatcher=new RegExp(term,'i');return termMatcher.test(lookup.desc);}
else{return true;}};}
if(_.has(options,'formatData')){formatData=options.formatData;}
else{formatData=function(data){return{id:data.id,text:data.desc+' ('+PORTAL.MODELS.providers.formatAvailableProviders(data.providers)+')'};};}
defaultOptions={allowClear:true,theme:'bootstrap',matcher:function(term,data){var searchTerm=(_.has(term,'term'))?term.term:'';if(isMatch(searchTerm,options.model.getLookup(data.id))){return data;}
else{return null;}},templateSelection:function(data){var result;if(_.has(data,'id')){result=data.id;}
else{result=null;}
return result;},data:_.map(options.model.getAll(),formatData)};el.select2($.extend(defaultOptions,select2Options));};PORTAL.VIEWS.createCascadedCodeSelect=function(el,options,select2Options){"use strict";var defaultOptions={allowClear:true,theme:'bootstrap'};if(!_.has(options,'isMatch')){options.isMatch=function(term,data){var termMatcher;if(term){termMatcher=new RegExp(term.term,'i');return termMatcher.test(data.id);}
else{return true;}};}
if(!_.has(options,'formatData')){options.formatData=function(data){return{id:data.id,text:data.desc+' ('+PORTAL.MODELS.providers.formatAvailableProviders(data.providers)+')'};};}
defaultOptions.ajax={transport:function(params,success,failure){var deferred=$.Deferred();var modelKeys=options.model.getAllKeys().sort();var selectedKeys=options.getKeys().sort();var filteredLookups;if(_.isEqual(modelKeys,selectedKeys)){filteredLookups=_.filter(options.model.getAll(),function(lookup){return options.isMatch(params.data.term,lookup);});deferred.resolve(filteredLookups);}
else{options.model.fetch(selectedKeys).done(function(data){deferred.resolve(data);}).fail(function(){deferred.reject();});}
deferred.done(success).fail(failure);return deferred.promise();},processResults:function(resp){var result=_.map(resp,function(lookup){return options.formatData(lookup);});return{results:result};}};el.select2($.extend(defaultOptions,select2Options));};var PORTAL=PORTAL||{};$(document).ready(function(){"use strict";if(Config.DEBUG){log.setLevel('debug',false);}
else{log.setLevel('warn',false);}
var $form=$('#params');var downloadProgressDialog=PORTAL.VIEWS.downloadProgressDialog($('#download-status-dialog'));var downloadFormView=PORTAL.VIEWS.downloadFormView({$form:$form,downloadProgressDialog:downloadProgressDialog});var identifyDialog=new IdentifyDialog('map-info-dialog',PORTAL.queryServices.getFormUrl);var siteMapView=PORTAL.VIEWS.siteMapView({$container:$('#mapping-div'),downloadProgressDialog:downloadProgressDialog,identifyDialog:identifyDialog,downloadFormView:downloadFormView});var initDownloadForm=downloadFormView.initialize();siteMapView.initialize();$('#show-queries-button').click(function(){var queryString=PORTAL.UTILS.getQueryString(downloadFormView.getQueryParamArray());var stationSection="<div class=\"show-query-text\"><b>Sites</b><br><textarea readonly=\"readonly\" rows='6'>"+PORTAL.queryServices.getFormUrl('Station',queryString)+"</textarea></div>";var resultSection="<div class=\"show-query-text\"><b>Results</b><br><textarea readonly=\"readonly\" rows='6'>"+PORTAL.queryServices.getFormUrl('Result',queryString)+"</textarea></div>";$('#WSFeedback').html(stationSection+resultSection);});initDownloadForm.fail(function(){$('#service-error-dialog').modal('show');});});var PORTAL=PORTAL||{};PORTAL.MODELS=PORTAL.MODELS||{};PORTAL.MODELS.providers=function(){"use strict";var ids=[];return{ fetch:function(){var deferred=$.Deferred();$.ajax({url:Config.CODES_ENDPOINT+'/providers',data:{mimeType:'json'},type:'GET',success:function(data,textStatus,jqXHR){ids=[];$.each(data.codes,function(index,code){ids.push(code.value);});deferred.resolve();},error:function(jqXHR,textStatus,error){ids=[];log.error('Unable to retrieve provider list with error: '+error);deferred.reject(error);}});return deferred.promise();},getIds:function(){return ids;}, formatAvailableProviders:function(availableProviders ){var isValidId=function(id){return _.contains(ids,id);};var availableList=availableProviders.split(' ');var resultList=_.filter(availableList,isValidId);if(resultList.length===ids.length){return'all';}
else{return resultList.join(', ');}}};}();var PORTAL=PORTAL||{};PORTAL.MODELS=PORTAL.MODELS||{};PORTAL.MODELS.cachedCodes=function(options){"use strict";var self={};var cachedData=[];self.fetch=function(){var fetchDeferred=$.Deferred();var URL=Config.CODES_ENDPOINT+'/'+options.codes;$.ajax({url:URL,type:'GET',data:{mimeType:'json'},success:function(data,textStatus,jqXHR){cachedData=_.map(data.codes,function(code){return{id:code.value,desc:(_.has(code,'desc')&&(code.desc))?code.desc:code.value,providers:code.providers};});fetchDeferred.resolve(cachedData);},error:function(jqXHR,textStatus,error){log.error('Can\'t  get '+options.codes+', Server error: '+error);fetchDeferred.reject(error);}});return fetchDeferred.promise();};self.getAll=function(){return cachedData;};self.getLookup=function(id){return _.find(cachedData,function(lookup){return(lookup.id===id);});};return self;};PORTAL.MODELS.codesWithKeys=function(options){"use strict";var self={};var cachedData=[];self.fetch=function(keys){var fetchDeferred=$.Deferred();var URL=Config.CODES_ENDPOINT+'/'+options.codes;$.ajax({url:URL+'?'+options.keyParameter+'='+keys.join(';'),type:'GET',data:{mimeType:'json'},success:function(data,textStatus,jqXHR){cachedData=_.map(keys,function(key){return{key:key,data:_.chain(data.codes).filter(function(lookup){return(options.parseKey(lookup.value)===key);}).map(function(lookup){return{id:lookup.value,desc:(_.has(lookup,'desc')&&(lookup.desc))?lookup.desc:lookup.value,providers:lookup.providers};}).value()};});fetchDeferred.resolve(self.getAll());},error:function(jqXHR,textStatus,error){log.error('Can\'t get '+options.codes+', Server error: '+error);fetchDeferred.reject(error);}});return fetchDeferred.promise();};self.getAll=function(){return _.chain(cachedData).pluck('data').flatten().value();};self.getAllKeys=function(){return _.pluck(cachedData,'key');};self.getDataForKey=function(key){var isMatch=function(object){return object.key===key;};var lookup=_.find(cachedData,isMatch);if(lookup){return lookup.data;}
else{return undefined;}};return self;};var PORTAL=PORTAL||{};PORTAL.DataSourceUtils=(function(){"use strict";var that={};that.getCountsFromHeader=function(xhr,dataSources){var formatCount=function(key){var countHeader=xhr.getResponseHeader(key);if(countHeader&&countHeader!=='0'){return numeral(countHeader).format('0,0');}
else{return'0';}};var result={};for(var i=0;i<dataSources.length;i++){var id=dataSources[i];result[id]={sites:formatCount(id+'-Site-Count'),results:formatCount(id+'-Result-Count')};}
result.total={sites:formatCount('Total-Site-Count'),results:formatCount('Total-Result-Count')};return result;};return that;}());var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.downloadFormView=function(options){"use strict";var self={};var getPlaceInputView=function(){var getCountryFromState=function(id){return(id)?id.split(':')[0]:'';};var getStateFromCounty=function(id){var ids=id.split(':');return(ids.length>1)?ids[0]+':'+ids[1]:'';};var countryModel=PORTAL.MODELS.cachedCodes({codes:'countrycode'});var stateModel=PORTAL.MODELS.codesWithKeys({codes:'statecode',keyParameter:'countrycode',parseKey:getCountryFromState});var countyModel=PORTAL.MODELS.codesWithKeys({codes:'countycode',keyParameter:'statecode',parseKey:getStateFromCounty});return PORTAL.VIEWS.placeInputView({$container:$('#place'),countryModel:countryModel,stateModel:stateModel,countyModel:countyModel});};self.initialize=function(){var placeInputView=getPlaceInputView();var pointLocationInputView=PORTAL.VIEWS.pointLocationInputView({$container:options.$form.find('#point-location')});var boundingBoxInputView=PORTAL.VIEWS.boundingBoxInputView({$container:options.$form.find('#bounding-box')});var siteParameterInputView=PORTAL.VIEWS.siteParameterInputView({$container:options.$form.find('#site-params'),siteTypeModel:PORTAL.MODELS.cachedCodes({codes:'sitetype'}),organizationModel:PORTAL.MODELS.cachedCodes({codes:'organization'})});var samplingParametersInputView=PORTAL.VIEWS.samplingParameterInputView({$container:options.$form.find('#sampling'),sampleMediaModel:PORTAL.MODELS.cachedCodes({codes:'samplemedia'}),characteristicTypeModel:PORTAL.MODELS.cachedCodes({codes:'characteristictype'})});var biologicalSamplingInputView=PORTAL.VIEWS.biologicalSamplingInputView({$container:options.$form.find('#biological'),assemblageModel:PORTAL.MODELS.cachedCodes({codes:'assemblage'})});var dataDetailsView=PORTAL.VIEWS.dataDetailsView({$container:options.$form.find('#download-box-input-div'),updateResultTypeAction:function(resultType){options.$form.attr('action',PORTAL.queryServices.getFormUrl(resultType));}});var initializeProviders=PORTAL.MODELS.providers.fetch().done(function(){PORTAL.VIEWS.createStaticSelect2(options.$form.find('#providers-select'),PORTAL.MODELS.providers.getIds());});var initPlaceInputView=placeInputView.initialize();var initSiteParameterInputView=siteParameterInputView.initialize();var initSamplingParametersInputView=samplingParametersInputView.initialize();var initBiologicalSamplingInputInputView=biologicalSamplingInputView.initialize();var initComplete=$.when(initBiologicalSamplingInputInputView,initializeProviders,initPlaceInputView,initSamplingParametersInputView,initSiteParameterInputView);dataDetailsView.initialize();pointLocationInputView.initialize();boundingBoxInputView.initialize();$('html').click(function(e){$('.popover-help').popover('hide');});options.$form.find('.popover-help').each(function(){var options=$.extend({},PORTAL.MODELS.help[($(this).data('help'))],{html:true,trigger:'manual'});$(this).popover(options).click(function(e){$(this).popover('toggle');e.stopPropagation();});});options.$form.find('.panel-heading .show-hide-toggle').click(function(){PORTAL.UTILS.toggleShowHideSections($(this),$(this).parents('.panel').find('.panel-body'));});options.$form.find('.subpanel-heading .show-hide-toggle').click(function(){PORTAL.UTILS.toggleShowHideSections($(this),$(this).parents('.subpanel').find('.subpanel-body'));});options.$form.find('#main-button').click(function(event){var fileFormat=dataDetailsView.getMimeType();var resultType=dataDetailsView.getResultType();var queryString=PORTAL.UTILS.getQueryString(self.getQueryParamArray());var startDownload=function(totalCount){_gaq.push(['_trackEvent','Portal Page',dataDetailsView.getResultType()+'Download',decodeURIComponent(queryString),parseInt(totalCount)]);options.$form.submit();};event.preventDefault();if(!PORTAL.CONTROLLERS.validateDownloadForm(options.$form)){return;}
_gaq.push(['_trackEvent','Portal Page',resultType+'Count',decodeURIComponent(queryString)]);options.downloadProgressDialog.show('download');PORTAL.queryServices.fetchHeadRequest(resultType,queryString).done(function(response){var counts=PORTAL.DataSourceUtils.getCountsFromHeader(response,PORTAL.MODELS.providers.getIds());options.downloadProgressDialog.updateProgress(counts,resultType,fileFormat,startDownload);}).fail(function(message){options.downloadProgressDialog.cancelProgress(message);});});return initComplete;};self.validateDownloadForm=function(){return PORTAL.CONTROLLERS.validateDownloadForm(options.$form);};self.getQueryParamArray=function(){var $formInputs=options.$form.find(':input').not('#mapping-div :input');return _.filter($formInputs.serializeArray(),function(param){return(param.value);});};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.siteMapView=function(options){"use strict";var self={};var mapId='query-results-map';var portalDataMap;self.initialize=function(){var $mapContainer=options.$container.find('#query-map-container');var $map=options.$container.find('#'+mapId);var $showHideBtn=options.$container.find('.show-hide-toggle');$map.height($mapContainer.height());$(window).resize(function(){var mapContainerHeight=$mapContainer.height();if(mapContainerHeight!==$map.height()){$map.height(mapContainerHeight);}});$showHideBtn.click(function(){var isVisible=PORTAL.UTILS.toggleShowHideSections($(this),$mapContainer);if(isVisible&&(!portalDataMap)){portalDataMap=new PortalDataMap(mapId,options.identifyDialog);}});options.$container.find('#show-on-map-button').click(function(){var queryParamArray=options.downloadFormView.getQueryParamArray();var queryString=PORTAL.UTILS.getQueryString(queryParamArray);var showMap=function(totalCount){if($mapContainer.is(':hidden')){$showHideBtn.click();}
_gaq.push(['_trackEvent','Portal Map','MapCreate',decodeURIComponent(queryString),parseInt(totalCount)]);$(this).attr('disabled','disabled').removeClass('query-button').addClass('disable-query-button');portalDataMap.showDataLayer(queryParamArray,function(){$(this).removeAttr('disabled').removeClass('disable-query-button').addClass('query-button');});};if(!options.downloadFormView.validateDownloadForm()){return;}
_gaq.push(['_trackEvent','Portal Map','MapCount',decodeURIComponent(queryString)]);options.downloadProgressDialog.show('map');PORTAL.queryServices.fetchHeadRequest('Station',queryString).done(function(response){var fileFormat='xml';var counts=PORTAL.DataSourceUtils.getCountsFromHeader(response,PORTAL.MODELS.providers.getIds());options.downloadProgressDialog.updateProgress(counts,'Station',fileFormat,showMap);}).fail(function(message){options.downloadProgressDialog.cancelProgress(message);});});};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.placeInputView=function(options){"use strict";var self={};var USA='US';var initializeCountrySelect=function($select,model){var isMatch=function(searchTerm,lookup){var termMatcher;if(searchTerm){termMatcher=new RegExp(searchTerm,'i');return(termMatcher.test(lookup.id)||(termMatcher.test(lookup.desc)));}
else{return true;}};var templateSelection=function(selectData){if(_.has(selectData,'id')){return selectData.id;}
else{return null;}};var spec={model:model,isMatch:isMatch};PORTAL.VIEWS.createCodeSelect($select,spec,{templateSelection:templateSelection});};var initializeStateSelect=function($select,model,getCountryKeys){var isMatch=function(searchTerm,lookup){var termMatcher;var codes;if(searchTerm){termMatcher=new RegExp(searchTerm,'i');codes=lookup.id.split(':');return(termMatcher.test(lookup.id)||termMatcher.test(lookup.desc)||termMatcher.test(stateFIPS.getPostalCode(codes[1])));}
else{return true;}};var spec={model:model,isMatch:isMatch,getKeys:getCountryKeys};var templateSelection=function(selectData){var codes;var result;if(_.has(selectData,'id')){codes=selectData.id.split(':');if(codes[0]===USA){result=codes[0]+':'+stateFIPS.getPostalCode(codes[1]);}
else{result=selectData.id;}}
else{result=null;}
return result;};PORTAL.VIEWS.createCascadedCodeSelect($select,spec,{templateSelection:templateSelection});};var initializeCountySelect=function($select,model,getStateKeys){var isMatch=function(searchTerm,lookup){var termMatcher;var county;if(searchTerm){termMatcher=new RegExp(searchTerm,'i');county=_.last(lookup.desc.split(','));return termMatcher.test(county);}
else{return true;}};var countySpec={model:model,isMatch:isMatch,getKeys:getStateKeys};var templateSelection=function(selectData){var codes;var result;if(_.has(selectData,'id')){codes=selectData.id.split(':');if(codes[0]==='US'){result=codes[0]+':'+stateFIPS.getPostalCode(codes[1])+':'+codes[2];}
else{result=selectData.id;}}
else{result=null;}
return result;};PORTAL.VIEWS.createCascadedCodeSelect($select,countySpec,{templateSelection:templateSelection});};self.initialize=function(){var $countrySelect=options.$container.find('#countrycode');var $stateSelect=options.$container.find('#statecode');var $countySelect=options.$container.find('#countycode');var fetchCountries=options.countryModel.fetch();var fetchUSStates=options.stateModel.fetch([USA]);var fetchComplete=$.when(fetchCountries,fetchUSStates);options.stateModel.fetch([USA]);var getCountryKeys=function(){var results=$countrySelect.val();return(results)?results:[USA];};var getStateKeys=function(){var results=$stateSelect.val();return(results)?results:[];};fetchCountries.done(function(){initializeCountrySelect($countrySelect,options.countryModel);});initializeStateSelect($stateSelect,options.stateModel,getCountryKeys);initializeCountySelect($countySelect,options.countyModel,getStateKeys);$countrySelect.on('change',function(ev){var countries=$(ev.target).val();var states=$stateSelect.val();var isInCountries=function(state){var countryCode=state.split(':')[0];return _.contains(countries,countryCode);};if(!countries){countries=[USA];}
$stateSelect.val(_.filter(states,isInCountries)).trigger('change');});$stateSelect.on('change',function(ev){var states=$(ev.target).val();var counties=$countySelect.val();var isInStates=function(county){var codes=county.split(':');var stateCode=codes[0]+':'+codes[1];return _.contains(states,stateCode);};$countySelect.val(_.filter(counties,isInStates)).trigger('change');});PORTAL.VIEWS.inputValidation({inputEl:$countySelect,validationFnc:function(val,ev){var result;if(getStateKeys().length===0){ev.preventDefault();result={isValid:false,errorMessage:'Please select at least one state'};}
else{result={isValid:true};}
return result;},event:'select2:opening'});return fetchComplete;};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.pointLocationInputView=function(options){"use strict";var self={};var updateMyLocation=function($lat,$lon){var updateInputs=function(position){$lat.val(position.coords.latitude);$lon.val(position.coords.longitude);};var displayError=function(err){log.error('ERROR('+err.code+'): '+err.message);};navigator.geolocation.getCurrentPosition(updateInputs,displayError,{timeout:8000,maximumAge:60000});return false;};self.initialize=function(){PORTAL.VIEWS.inputValidation({inputEl:options.$container.find('input[type="text"]'),validationFnc:PORTAL.validators.realNumberValidator});if(navigator.geolocation&&navigator.geolocation.getCurrentPosition){var $useMyLocationDiv=options.$container.find('#useMyLocation');var $lat=options.$container.find('#lat');var $lon=options.$container.find('#long');$useMyLocationDiv.html('<button class="btn btn-info" type="button">Use my location</button>');$useMyLocationDiv.find('button').click(function(){updateMyLocation($lat,$lon);});}};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.boundingBoxInputView=function(options){"use strict";var self={};self.initialize=function(){var $textInputs=options.$container.find('input[type="text"]');var $north=options.$container.find('#north');var $south=options.$container.find('#south');var $west=options.$container.find('#west');var $east=options.$container.find('#east');PORTAL.VIEWS.inputValidation({inputEl:$textInputs,validationFnc:PORTAL.validators.realNumberValidator});$textInputs.change(function(){var north=$north.val();var south=$south.val();var east=$east.val();var west=$west.val();var bboxVal='';if((north)&&(south)&&(east)&&(west)){bboxVal=west+','+south+','+east+','+north;}
options.$container.find('input[name="bBox"]').val(bboxVal);});};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.siteParameterInputView=function(options){"use strict";var self={};var initializeOrganizationSelect=function($select,model){var formatData=function(data){return{id:data.id,text:data.id+' - '+data.desc};};var isMatch=function(searchTerm,data){var termMatcher;if(searchTerm){termMatcher=new RegExp(searchTerm,'i');return(termMatcher.test(data.id)||termMatcher.test(data.desc));}
else{return true;}};PORTAL.VIEWS.createCodeSelect($select,{model:model,formatData:formatData,isMatch:isMatch},{minimumInputLength:2,closeOnSelect:false});};self.initialize=function(){var $siteTypeSelect=options.$container.find('#siteType');var $organizationSelect=options.$container.find('#organization');var $siteIdInput=options.$container.find('#siteid');var $hucInput=options.$container.find('#huc');var fetchSiteType=options.siteTypeModel.fetch()
var fetchOrganization=options.organizationModel.fetch()
var fetchComplete=$.when(fetchSiteType,fetchOrganization);fetchSiteType.done(function(){PORTAL.VIEWS.createCodeSelect($siteTypeSelect,{model:options.siteTypeModel});});fetchOrganization.done(function(){initializeOrganizationSelect($organizationSelect,options.organizationModel);});PORTAL.VIEWS.inputValidation({inputEl:$siteIdInput,validationFnc:PORTAL.validators.siteIdValidator});PORTAL.VIEWS.inputValidation({inputEl:$hucInput,validationFnc:PORTAL.hucValidator.validate,updateFnc:PORTAL.hucValidator.format});return fetchComplete;};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.samplingParameterInputView=function(options){"use strict";var self={};self.initialize=function(){var $sampleMedia=options.$container.find('#sampleMedia');var $characteristicType=options.$container.find('#characteristicType');var $characteristicName=options.$container.find('#characteristicName');var $projectCode=options.$container.find('#project-code');var $startDate=options.$container.find('#startDateLo');var $endDate=options.$container.find('#startDateHi');var fetchSampleMedia=options.sampleMediaModel.fetch();var fetchCharacteristicType=options.characteristicTypeModel.fetch();var fetchComplete=$.when(fetchSampleMedia,fetchCharacteristicType);fetchSampleMedia.done(function(){PORTAL.VIEWS.createCodeSelect($sampleMedia,{model:options.sampleMediaModel});});fetchCharacteristicType.done(function(){PORTAL.VIEWS.createCodeSelect($characteristicType,{model:options.characteristicTypeModel});});PORTAL.VIEWS.createPagedCodeSelect($characteristicName,{codes:'characteristicname'},{closeOnSelect:false});PORTAL.VIEWS.createPagedCodeSelect($projectCode,{codes:'project'},{closeOnSelect:false});PORTAL.VIEWS.inputValidation({inputEl:$startDate,validationFnc:PORTAL.dateValidator.validate,updateFnc:function(value){return PORTAL.dateValidator.format(value,true);}});PORTAL.VIEWS.inputValidation({inputEl:$endDate,validationFnc:PORTAL.dateValidator.validate,updateFnc:function(value){return PORTAL.dateValidator.format(value,false);}});return fetchComplete;};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.biologicalSamplingInputView=function(options){"use strict";var self={};self.initialize=function(){var $assemblage=options.$container.find('#assemblage');var $taxonomicName=options.$container.find('#subject-taxonomic-name');var fetchAssemblageModel=options.assemblageModel.fetch();var fetchComplete=$.when(fetchAssemblageModel);fetchAssemblageModel.done(function(){PORTAL.VIEWS.createCodeSelect($assemblage,{model:options.assemblageModel});});PORTAL.VIEWS.createPagedCodeSelect($taxonomicName,{codes:'subjecttaxonomicname'},{closeOnSelect:false});return fetchComplete;};return self;};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.dataDetailsView=function(options){"use strict";var self={};self.initialize=function(){var $kml=options.$container.find('#kml');var $site=options.$container.find('#sites');var $samples=options.$container.find('#samples');var $biosamples=options.$container.find('#biosamples');var $sorted=options.$container.find('#sorted');var $hiddenSorted=options.$container.find('input[type="hidden"][name="sorted"]');var $mimeTypeRadioboxes=options.$container.find('input[name="mimeType"]');var $resultTypeRadioboxes=options.$container.find('input.result-type');$mimeTypeRadioboxes.change(function(){var kmlChecked=$kml.prop('checked');PORTAL.UTILS.setEnabled($samples,!kmlChecked);PORTAL.UTILS.setEnabled($biosamples,!kmlChecked);});$resultTypeRadioboxes.change(function(){var resultType=$(this).val();var $dataProfile=options.$container.find('input[name="dataProfile"]');options.$container.find('input.result-type:checked').not(this).prop('checked',false);PORTAL.UTILS.setEnabled($kml,$site.prop('checked'));if($biosamples.prop('checked')){if($dataProfile.length===0){options.$container.append('<input type="hidden" name="dataProfile" value="biological" />');}}
else{$dataProfile.remove();}
options.updateResultTypeAction(resultType);});$sorted.change(function(){var val=$(this).is(':checked')?'yes':'no';$hiddenSorted.val(val);});};self.getResultType=function(){return options.$container.find('input.result-type:checked').val();};self.getMimeType=function(){return options.$container.find('input[name="mimeType"]:checked').val();};return self;};var PORTAL=PORTAL||{};PORTAL.MODELS=PORTAL.MODELS||{};PORTAL.MODELS.help={country:{placement:'auto',title:'Country Help',content:'\
        <div>Countries represented in the database can be selected from the drop down list. \
        The available data sources are listed in parenthesis for each country. Multiple countries\
        may be selected. \
        </div>'},state:{placement:'auto',title:'State Help',content:'\
        <div>States or provinces for the selected countries can be selected from the drop down list. \
        If the countries select is clear, then US states are available. Selections are shown as XX:YY where \
        XX is the country code and YY is the FIPS code with the exception that postal code is shown for US states. \n\
        The available data sources are listed in parenthesis for each state. Multiple states may be selected. \
        </div>'},county:{placement:'auto',title:'County Help',content:'\
        <div>Counties for the selected states can be selected from the drop down list. \
        Selections are shown as XX:YY:ZZZ where XX is the country code, YY is the FIPS or postal code and \
        ZZZ is the county postal code. The available data sources are listed in parenthesis for each county. \
        Multiple counties may be selected.\
        </div>'},pointLocation:{placement:'auto',title:'Point Location Help',content:'\
                <div>Enter a latitude and longitude and a radial distance \
                        to create a search area. Distance should be entered in \
                        miles. Latitude and longitude should be entered in \
                        decimal degrees relative to the NAD83 datum. Longitudes \
                        in the western hemisphere should be preceded with a \
                        negative sign ("-"). Many stations outside the continental US do not have latitude and longitude referenced to WGS84 \
                        and therefore cannot be found using these parameters.\
                </div>\
                <br />\
                <div>\
                        <b>Example:</b>\
                        <br/>\
                        20 miles from Latitude 46.12 degrees N, Longitude 89.15 degrees W would be entered as:\
                        <ul>\
                                <li>Distance: 20</li>\
                                <li>Latitude: 46.12</li>\
                                <li>Longitude: -89.15</li>\
                        </ul>\
                </div>'},boundingBox:{placement:'auto',title:'Bounding Box Help',content:'\
                <div>Enter the North and South latitudes and the East and \
                West longitudes to create a bounding box. Latitude \
                and Longitude should be entered in decimal degrees \
                relative to the NAD83 datum. Longitudes in the \
                western hemisphere should be preceded with a negative sign ("-").\
                </div>\
                <br />\
                <div>\
                <b>Example:</b>\
                <ul>\
                        <li>North: 46.12</li>\
                        <li>East: -89.15</li>\
                        <li>South: 45.93</li>\
                        <li>West: -89.68</li>\
                </ul>\
                </div>'},siteType:{placement:'auto',title:'Site Type Help',content:'\
	        <div>\
	        A site type is a generalized location in the hydrologic cycle, or a man-made \
	        feature thought to affect the hydrologic conditions measured at a site. Site types can be selected \
	        from the drop down list. The available data sources are listed in parenthesis for each \
	        site type. Multiple site types may be selected.\
	        </div>'},organization:{placement:'auto',title:'Organization Help',content:'\
            <div>\
            A designator used to identify a unique business establishment within a context. \
            Select from a list of organization IDs represented in the source databases.\
            Multiple IDs may be selected.\
            </div>'},siteID:{placement:'auto',title:'Site ID Help',content:'\
                <div> \
                A site id is a designator used to describe the unique name, number, or code assigned to identify the monitoring\
                location.  Site IDs are case-sensitive and should be entered in the following format: AGENCY-STATION NUMBER.  More\
                than one site ID may be entered, separated by semicolons.  If you are entering an NWIS site, use "USGS" as the AGENCY.\
                </div>\
                <br />\
                <div>\
                <b>Examples:</b>\
                <ul>\
                        <li><i>For NWIS site:</i> USGS-301650084300701</li>\
                        <li><i>For STORET site:</i> R10BUNKER-CUA005-5</li>\
                        <li><i>For multiple sites:</i><br/> IN002-413354086221001;USSCS-311257091521312;USEPA-414007085591501</li>\
                </ul>\
        </div>\
        <p>For further information about NWIS versus STORET site ids, go to the <a href="faqs.jsp#WQPFAQs-SiteIDs" target="FAQWin">FAQs</a> page</p>'},huc:{placement:'auto',title:'HUC Help',content:'\
                <div>A HUC is a federal code used to identify the hydrologic unit of the monitoring location to the cataloging unit\
                level of precision.  Full hydrologic unit codes (HUCs) or partial HUCs using trailing wildcards may be entered.  Only\
                trailing wildcards are accepted.  More than one HUC may be entered, separated by semicolons.\
                The <A href="http://water.usgs.gov/GIS/huc.html" target="_blank">lists and maps of hydrologic units</A>\
                are available from the USGS.</div>\
                <br />\
                <div>\
                <b>Examples:</b>\
                <ul>\
                        <li>01010003;01010004</li>\
                        <li>010801*</li>\
                        <li>01010003;010801*;01010005</li>\
                </ul>\
                </div>'},sampleMedia:{placement:'auto',title:'Sample Media Help',content:'\
        <div>A sample media indicates the environmental medium where a sample was taken. \
        Sample media can be selected \
        from the drop down list. The available data sources are listed in parenthesis for each \
        sample media. Multiple sample media may be selected.\
        </div>'},characteristicGroup:{placement:'auto',title:'Characteristic Group Help',content:'\
        <div>A characteristic group can be selected \
        from the drop down list. The available data sources are listed in parenthesis for each \
        characteristic group. Multiple characteristic groups may be selected.\
        </div>'},characteristicName:{placement:'auto',title:'Characteristics Help',content:'\
        <div>A characteristic identifies different types of environmental measurements. \
        The names are derived from the USEPA \
        <a href="http://iaspub.epa.gov/sor_internet/registry/substreg/home/overview/home.do" target="_blank">Substance Registry System (SRS)</a>. \
        The available data \
        sources are listed in parenthesis for each characteristic. Multiple characteristics may \
        be selected. </div>'},project:{placement:'auto',title:'Project ID Help',content:'\
    		The Project identifier is a designator used to uniquely identify a data collection project within a context of an organization.'},pcode:{placement:'auto',title:'Parameter Code Help',content:'\
                <div>A Parameter Code is a 5-digit number used in NWIS to uniquely identify a specific characteristic.  \
                One or more five-digit USGS parameter codes can be requested, separated by semicolons. For more information on NWIS \n\
                pcodes see <a target="_blank" href="http://nwis.waterdata.usgs.gov/usa/nwis/pmcodes">http://nwis.waterdata.usgs.gov/usa/nwis/pmcodes</a></div>\
                <br>\
                <div class="instructions"><b>Please Note:</b> Specifying a Parameter Code will limit the query to NWIS only.</div>\
                <br />\
                <div>\
                <b>Examples:</b>\
                <ul>\
                        <li>00065</li>\
                        <li>00065;00010</li>\
                </ul>\
                </div>'},nawqa:{placement:'auto',title:'NAWQA Program Only Help',content:'\
        	<div>National Water Quality Assessment Program Samples Only (NAWQA, NASQAN, and NMN)</div>'},biologicalparams:{placement:'auto',title:'Biological Sampling Parameters Help',content:'\
        	<div>These parameters are related to samples of biological organisms, such as species name or the assemblage that a group of organisms belongs to</div'},taxonomicName:{placement:'auto',title:'Taxonomic Name Help',content:'\
        	<div>The Taxonomic Name parameter queries the SubjectTaxonomicName in the WQP output.  This is typically in Genus species binomial nomenclature form.  For example, \
        	to look for sites sampled for the shovelnose sturgeon, enter <i>Scaphirhynchus platorynchus</i></div>'},assemblage:{placement:'auto',title:'Assemblage Help',content:'\
    		<div>The Assemblage is specific to biological collection data, and refers to "An association \
    		of interacting populations of organisms in a given waterbody."  Examples include macroinvertabrates and fish/nekton.  </div>'},xmlSchema:{placement:'auto',title:'WQX-Outbound Schema Info',content:'\
                <div>The Water Quality Portal (WQP) \
                        Web Services conform to the format defined in the below referenced XML schema.\
                </div> \
                <br />\
                <div>\
                <b>WQX-Outbound XML schema information:</b>\
                <ul>\
                        <li><a href="schemas/WQX-Outbound/2_0/index.xsd" target="_blank">WQX-Outbound XML schema</a></li>\
                        <li><a href="schemas/WQX-Outbound/2_0/docs/index.html" target="_blank">WQX-Outbound XML schema documentation</a></li>\
                </ul>\
                </div>'}};var stateFIPS={fipsMap:{'01':{name:'Alabama',postalCode:'AL'},'02':{name:'Alaska',postalCode:'AK'},'04':{name:'Arizona',postalCode:'AZ'},'05':{name:'Arkansas',postalCode:'AR'},'06':{name:'California',postalCode:'CA'},'08':{name:'Colorado',postalCode:'CO'},'09':{name:'Connecticut',postalCode:'CT'},'10':{name:'Delaware',postalCode:'DE'},'11':{name:'District of Columbia',postalCode:'DC'},'12':{name:'Florida',postalCode:'FL'},'13':{name:'Georgia',postalCode:'GA'},'15':{name:'Hawaii',postalCode:'HI'},'16':{name:'Idaho',postalCode:'ID'},'17':{name:'Illinois',postalCode:'IL'},'18':{name:'Indiana',postalCode:'IN'},'19':{name:'Iowa',postalCode:'IA'},'20':{name:'Kansas',postalCode:'KS'},'21':{name:'Kentucky',postalCode:'KY'},'22':{name:'Louisiana',postalCode:'LA'},'23':{name:'Maine',postalCode:'ME'},'24':{name:'Maryland',postalCode:'MD'},'25':{name:'Massachusetts',postalCode:'MA'},'26':{name:'Michigan',postalCode:'MI'},'27':{name:'Minnesota',postalCode:'MN'},'28':{name:'Mississippi',postalCode:'MS'},'29':{name:'Missouri',postalCode:'MO'},'30':{name:'Montana',postalCode:'MT'},'31':{name:'Nebraska',postalCode:'NE'},'32':{name:'Nevada',postalCode:'NV'},'33':{name:'New Hampshire',postalCode:'NH'},'34':{name:'New Jersey',postalCode:'NJ'},'35':{name:'New Mexico',postalCode:'NM'},'36':{name:'New York',postalCode:'NY'},'37':{name:'North Carolina',postalCode:'NC'},'38':{name:'North Dakota',postalCode:'ND'},'39':{name:'Ohio',postalCode:'OH'},'40':{name:'Oklahoma',postalCode:'OK'},'41':{name:'Oregon',postalCode:'OR'},'42':{name:'Pennsylvania',postalCode:'PA'},'44':{name:'Rhode Island',postalCode:'RI'},'45':{name:'South Carolina',postalCode:'SC'},'46':{name:'South Dakota',postalCode:'SD'},'47':{name:'Tennessee',postalCode:'TN'},'48':{name:'Texas',postalCode:'TX'},'49':{name:'Utah',postalCode:'UT'},'50':{name:'Vermont',postalCode:'VT'},'51':{name:'Virginia',postalCode:'VA'},'53':{name:'Washington',postalCode:'WA'},'54':{name:'West Virginia',postalCode:'WV'},'55':{name:'Wisconsin',postalCode:'WI'},'56':{name:'Wyoming',postalCode:'WY'},'60':{name:'American Samoa',postalCode:'AS'},'64':{name:'Federated States of Micronesia',postalCode:'FM'},'66':{name:'Guam',postalCode:'GU'},'68':{name:'Marshall Islands',postalCode:'MH'},'69':{name:'Northern Mariana Islands',postalCode:'MP'},'70':{name:'Palau',postalCode:'PW'},'72':{name:'Puerto Rico',postalCode:'PR'},'74':{name:'U.S. Minor Outlying Islands',postalCode:'UM'},'78':{name:'Virgin Islands of the U.S.',postalCode:'VI'}},getPostalCode:function(fips ){if(stateFIPS.fipsMap[fips]){return stateFIPS.fipsMap[fips].postalCode;}
else{return'';}},getName:function(fips ){if(stateFIPS.fipsMap[fips]){return stateFIPS.fipsMap[fips].name;}
else{return'';}},getFromPostalCode:function(postalCode ){for(var fips in stateFIPS.fipsMap){if(stateFIPS.fipsMap[fips].postalCode===postalCode){return fips;}}
return'';}};var PORTAL=PORTAL||{};PORTAL.dateValidator=function(){var DELIM='-';var sepRegExp=new RegExp('/','g');var INVALID={isValid:false,errorMessage:'Dates should be entered as mm-dd-yyyy, mm-yyyy, or yyyy'};var VALID={isValid:true};var that={};that.validate=function(value){var dateValues;var i;if(value){dateValues=value.replace(sepRegExp,'-').split('-');if(dateValues.length>3){return INVALID;}
else
for(i=0;i<dateValues.length;i++){if(!dateValues[i]||isNaN(dateValues[i])){return INVALID;}}
if(dateValues.length===3){if(dateValues[0].length<3&&dateValues[1].length<3&&dateValues[2].length===4){return VALID;}}
else if(dateValues.length===2){if(dateValues[0].length<3&&dateValues[1].length===4){return VALID;}}
else{if(dateValues[0].length===4){return VALID;}}
return INVALID;}
else{return VALID;}};that.format=function(value,isLow){var getZeroFilled=function(n,width){var result=n;var i;if(n.length<width){for(i=0;i<width-n.length;i++){result='0'+result;}}
return result;};var month,day,year;var dateValues;if(value){dateValues=value.replace(sepRegExp,'-').split('-');if(dateValues.length===3){month=getZeroFilled(dateValues[0],2);day=getZeroFilled(dateValues[1],2);year=dateValues[2];}
else if(dateValues.length===2){month=getZeroFilled(dateValues[0],2);year=dateValues[1];if(isLow){day='01';}
else{day=(new Date(year,month,0)).getDate();}}
else if(dateValues.length===1){year=dateValues[0];if(isLow){day='01';month='01';}
else{day='31';month='12';}}
return month+DELIM+day+DELIM+year;}
else{return'';}};return that;}();var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.downloadProgressDialog=function(el){"use strict";var that={};var DIALOG={map:{title:'Map Sites Status',continueMessage:'map the sites',cancelDownload:function(sitesCount){var intSiteCount=parseInt(sitesCount.split(',').join(''));return(intSiteCount>250000);},cancelMessage:'Your query is returning more than 250,000 sites and can not be mapped.'},download:{title:'Download Status',continueMessage:'download the data',cancelDownload:function(counts,fileFormat){return(fileFormat==='xlsx')&&(parseInt(counts.split(',').join(''))>1048575);},cancelMessage:'Your query is returning more than 1,048,575 results which exceeds Excel\'s limit.'}};var opKind;var buttonHtml=function(id,label){return'<button id="'+id+'" type="button" class="btn btn-default">'+label+'</button>';};that.show=function(thisOpKind){opKind=thisOpKind;el.find('.modal-footer').html('');el.find('.modal-body').html('Validating query ... Please wait.');el.find('.modal-header h4').html(DIALOG[opKind].title);el.modal('show');};that.hide=function(){el.modal('hide');};that.updateProgress=function(counts,resultType,fileFormat,continueFnc){var i;var id;var resultsReturned=resultType!=='Station';var totalCount=resultsReturned?counts.total.results:counts.total.sites;var getCountMessage=function(){var message='Your query will return ';var providers=PORTAL.MODELS.providers.getIds();if(resultsReturned){message+='<b>'+counts.total.results+'</b> sample results from <b>'+counts.total.sites+'</b> sites:<br />';for(i=0;i<providers.length;i++){id=providers[i];message+='From '+id+': '+counts[id].results+' sample results from '+counts[id].sites+' sites<br />';}}
else{message+=counts.total.sites+':<br />';for(i=0;i<providers.length;i++){id=providers[i];message+='From '+id+': '+counts[id].sites+'<br/>';}}
return message;};if(totalCount==='0'){that.cancelProgress('Your query returned no data to download.');}
else if(DIALOG[opKind].cancelDownload(totalCount,fileFormat)){that.cancelProgress(getCountMessage()+DIALOG[opKind].cancelMessage);}
else{el.find('.modal-body').html(getCountMessage()+'<p>Click Continue to '+DIALOG[opKind].continueMessage);el.find('.modal-footer').html(buttonHtml('progress-cancel-btn','Cancel')+
buttonHtml('progress-continue-btn','Continue'));$('#progress-cancel-btn').click(function(){el.modal('hide');});$('#progress-continue-btn').click(function(){el.modal('hide');continueFnc(totalCount);});}};that.cancelProgress=function(message){el.find('.modal-body').html(message);el.find('.modal-footer').html(buttonHtml('progress-ok-btn','Ok'));$('#progress-ok-btn').click(function(){el.modal('hide');});};return that;};var PORTAL=PORTAL||{};PORTAL.CONTROLLER=PORTAL.CONTROLLER||{};PORTAL.CONTROLLER.retrieveSiteIdInfo=function(siteIds,updateFnc,successFnc){if(!successFnc){successFnc=function(){return;};}
if(siteIds.length>0){var idsToGet=siteIds.slice(0,Math.min(siteIds.length,50));updateFnc('Retrieving site ID data');$.ajax({url:Config.QUERY_URLS.Station,type:'GET',data:'siteid='+encodeURIComponent(idsToGet.join(';'))+'&mimeType=xml',success:function(data,textStatus,jqXHR){var detailHtml='';var orgEls=$(data).find('Organization');if(siteIds.length>50){detailHtml+='Retrieved '+siteIds.length+' sites, only showing 50<br />';}
orgEls.each(function(){var orgId=$(this).find('OrganizationIdentifier').text();var orgName=$(this).find('OrganizationFormalName').text();$(this).find('MonitoringLocation').each(function(){detailHtml+='<br />';detailHtml+='<table>';detailHtml+='<tr><th>Station ID: </th><td class="details-site-id">'+$(this).find('MonitoringLocationIdentifier').text()+'</td></tr>';detailHtml+='<tr><th>Name: </th><td>'+$(this).find('MonitoringLocationName').text()+'</td></tr>';detailHtml+='<tr><th>Type: </th><td>'+$(this).find('MonitoringLocationTypeName').text()+'</td></tr>';detailHtml+='<tr><th>HUC 8: </th><td>'+$(this).find('HUCEightDigitCode').text()+'</td></tr>';detailHtml+='<tr><th>Org ID: </th><td>'+orgId+'</td></tr>';detailHtml+='<tr><th>Org Name: </th><td>'+orgName+'</td></tr>';detailHtml+='</table>';});});updateFnc(detailHtml);successFnc();},error:function(jqXHR,textStatus,error){updateFnc('Unable to retrieve site information');}});}
else{updateFnc('No sites at selection point');}};var PORTAL=PORTAL||{};PORTAL.VIEWS=PORTAL.VIEWS||{};PORTAL.VIEWS.inputValidation=function(spec){"use strict";var event=spec.event||'change';spec.inputEl.on(event,function(ev){var inputValue=$(this).val();var result=spec.validationFnc(inputValue,ev);var parent=$(this).parent();parent.find('.error-message').remove();if(result.isValid){parent.removeClass('alert alert-danger');if(spec.updateFnc){$(this).val(spec.updateFnc(inputValue));}}
else{parent.addClass('alert alert-danger');parent.append('<div class="error-message">'+result.errorMessage+'</div>');}});};var PORTAL=PORTAL||{};PORTAL.validators=function(){var that={};that.siteIdValidator=function(value){var dashIndex;if(value){dashIndex=value.indexOf('-');if(dashIndex===-1||dashIndex===0||dashIndex===value.length-1){return{isValid:false,errorMessage:'Format is AGENCY-STATION. NWIS sites should use "USGS" as the AGENCY.'};}
else{return{isValid:true};}}
else{return{isValid:true};}};that.realNumberValidator=function(value){if(value){if(isNaN(value)){return{isValid:false,errorMessage:'Enter a floating point number.'};}
else{return{isValid:true};}}
else{return{isValid:true};}};return that;}();var PORTAL=PORTAL||{};PORTAL.CONTROLLERS=PORTAL.CONTROLLERS||{};PORTAL.CONTROLLERS.validatePointLocation=function(spec){var within=spec.withinEl.val();var lat=spec.latEl.val();var lon=spec.lonEl.val();if((within)&&(lat)&&(lon)){return{isValid:true};}
else if((within)||(lat)||(lon)){return{isValid:false,errorMessage:'In Point Location all parameters must be blank or all parameters must have a non-blank value'};}
else{return{isValid:true};}};PORTAL.CONTROLLERS.validateBoundingBox=function(spec){var north=spec.northEl.val();var south=spec.southEl.val();var east=spec.eastEl.val();var west=spec.westEl.val();if((north)&&(south)&&(east)&&(west)){if(parseFloat(south)>=parseFloat(north)){return{isValid:false,errorMessage:'In Bounding Box, north must be greater than south'};}
else if(parseFloat(west)>=parseFloat(east)){return{isValid:false,errorMessage:'In Bounding Box, east must be greater than west'};}
else{return{isValid:true};}}
else if((north)||(south)||(east)||(west)){return{isValid:false,errorMessage:'In Bounding Box, all parameters must be blank or all must have a non-blank value.'};}
else{return{isValid:true};}};PORTAL.CONTROLLERS.validateDateRange=function(spec){var getDate=function(value){dateArray=value.split('-');return new Date(dateArray[2],dateArray[0]-1,dateArray[1],0,0,0,0);};var fromDateStr=spec.fromDateEl.val();var toDateStr=spec.toDateEl.val();if((fromDateStr)&&(toDateStr)){if(getDate(fromDateStr)<getDate(toDateStr)){return{isValid:true};}
else{return{isValid:false,errorMessage:'From date must be before to date'};}}
else{return{isValid:true};}};PORTAL.CONTROLLERS.validateDownloadForm=function($form){var validateModalEl=$('#validate-download-dialog');var showModal=function(message){validateModalEl.find('.modal-body').html(message);validateModalEl.modal('show');};if($form.find('.error-message').length>0){showModal('Need to correct input validation errors on form');return false;}
var result;result=PORTAL.CONTROLLERS.validatePointLocation({withinEl:$form.find('#within'),latEl:$form.find('#lat'),lonEl:$form.find('#long')});if(!result.isValid){showModal(result.errorMessage);return false;}
result=PORTAL.CONTROLLERS.validateBoundingBox({northEl:$form.find('#north'),southEl:$form.find('#south'),eastEl:$form.find('#east'),westEl:$form.find('#west')});if(!result.isValid){showModal(result.errorMessage);return false;}
result=PORTAL.CONTROLLERS.validateDateRange({fromDateEl:$form.find('#startDateLo'),toDateEl:$form.find('#startDateHi')});if(!result.isValid){showModal(result.errorMessage);return false;}
return true;};var PORTAL=PORTAL||{};PORTAL.hucValidator=function(){var INVALID={isValid:false,errorMessage:'HUCs should be entered as semi-colon separated numbers with 2, 4, 6 or 8 digits with optional \'*\' wildcard'};var VALID={isValid:true};var starReg=/\*$/g;var that={};that.validate=function(value){var i;var thisHuc;var hucArray=value.split(';');for(i=0;i<hucArray.length;i++){if(hucArray[i]){if(hucArray[i].length>8){return INVALID;}
thisHuc=hucArray[i].replace(starReg,'');if(isNaN(thisHuc)){return INVALID;}
if(thisHuc.length!==2&&thisHuc.length!==4&&thisHuc.length!==6&&thisHuc.length!==8){return INVALID;}}}
return VALID;};that.format=function(value){var i;var resultArray=[];var hucArray=value.split(';');for(i=0;i<hucArray.length;i++){if(hucArray[i]){if(hucArray[i].search(starReg)===-1&&hucArray[i].length<8){resultArray.push(hucArray[i]+'*');}
else{resultArray.push(hucArray[i]);}}}
return resultArray.join(';');};return that;}();