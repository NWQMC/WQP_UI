var MapUtils={};MapUtils.XYZ_URL_POSTFIX='${z}/${y}/${x}';MapUtils.MERCATOR_PROJECTION=new OpenLayers.Projection("EPSG:900913");MapUtils.WGS84_PROJECTION=new OpenLayers.Projection("EPSG:4326");MapUtils.DEFAULT_CENTER={lon:-82.5,lat:48.2};MapUtils.MAP_OPTIONS={projection:MapUtils.MERCATOR_PROJECTION,maxResolution:156543.0339,maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.ArgParser(),new OpenLayers.Control.Attribution(),new OpenLayers.Control.Zoom(),new OpenLayers.Control.ScaleLine(),new OpenLayers.Control.MousePosition({formatOutput:function(lonLat){lonLat.transform(MapUtils.MERCATOR_PROJECTION,MapUtils.WGS84_PROJECTION);return lonLat.toShortString();}}),new OpenLayers.Control.LayerSwitcher()]};MapUtils.BASE_LAYERS={light_grey_base:{type:OpenLayers.Layer.XYZ,name:'World Light Gray',url:'http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX},world_street:{type:OpenLayers.Layer.XYZ,name:'World Street',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX},world_imagery:{type:OpenLayers.Layer.XYZ,name:'World Imagery',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX},world_topo:{type:OpenLayers.Layer.XYZ,name:'World Topo',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX},world_relief:{type:OpenLayers.Layer.XYZ,name:'World Relief',url:'http://services.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/'+MapUtils.XYZ_URL_POSTFIX}};
MapUtils.getLayer=function(layer,options){if(layer.type==OpenLayers.Layer.Stamen){return new OpenLayers.Layer.Stamen(layer.name,options);}
else{return new layer.type(layer.name,layer.url,options);}}
MapUtils.getNWISSitesLayer=function(options,params){options=options?options:{};params=params?params:{};var defaultOptions={layers:'NWC:gagesII',version:'1.1.1',format:'image/png',transparent:true,tiled:true};var defaultParams={isBaseLayer:false,displayInLayerSwitcher:true,visibility:false,singleTile:true
}
var finalParams=$.extend({},defaultParams,params);var finalOptions=$.extend({},defaultOptions,options);var sldDeferred=$.Deferred();$.ajax({url:Config.NWIS_SITE_SLD_URL,dataType:'text',success:function(data){finalOptions.sld_body=data;sldDeferred.resolve(new OpenLayers.Layer.WMS('NWIS Sites','http://cida.usgs.gov/nwc/proxy/geoserver/NWC/wms',finalOptions,finalParams));},error:function(){sldDeferred.resolve(new OpenLayers.Layer.WMS('NWIS Sites','http://cida.usgs.gov/nwc/proxy/geoserver/NWC/wms',finalOptions,finalParams))}});return sldDeferred;}
CoverageMapConfig={};CoverageMapConfig.LAYER_PARAM={'states':'qw_portal_map:states_all','counties':'qw_portal_map:counties_all','huc8':'qw_portal_map:huc8_all'};CoverageMapConfig.SOURCE_VIEWPARAMS={'storet':'source1:E;source2:E','nwis':'source1:N;source2:N','all':'source1:E;source2:N'};CoverageMapConfig.get_viewparams=function(date_filter,source){return CoverageMapConfig.SOURCE_VIEWPARAMS[source]+';timeFrame:'+date_filter;};CoverageMapConfig.SLD_DATASOURCE={'storet':'E','nwis':'N','all':'A'};CoverageMapConfig.SLD_GEOMETRY={'states':'S','counties':'C','huc8':'H'};CoverageMapConfig.SLD_TIMEFRAME={'past_12_months':'1','past_60_months':'5','all_time':'A'};CoverageMapConfig.get_sld_param=function(display_by,date_filter,source){return Config.SLD_ENDPOINT+'?dataSource='+CoverageMapConfig.SLD_DATASOURCE[source]+'&geometry='+CoverageMapConfig.SLD_GEOMETRY[display_by]+'&timeFrame='+CoverageMapConfig.SLD_TIMEFRAME[date_filter];};CoverageMapConfig.TITLE_ATTR={'states':'STATE','counties':'COUNTY_NAME','huc8':'CAT_NUM'};var CoverageMap={};CoverageMap.map;CoverageMap.dataLayer;CoverageMap.BASE_LAYERS=['light_grey_base','world_street'];CoverageMap.zoomTo=function(l,b,r,t){var bounds=new OpenLayers.Bounds(l,b,r,t);bounds.transform(MapUtils.WGS84_PROJECTION,MapUtils.MERCATOR_PROJECTION);CoverageMap.map.zoomToExtent(bounds);return false;};CoverageMap.init=function(divId){OpenLayers.ProxyHost=""
var detailDialogEl=$('#map-detail-dialog');var getCount=function(object,property){if(property in object){return $.formatNumber(object[property],{format:'#,###',locale:'us'});}
else{return'0';}};var formatInfo=function(feature){var html='';html='<button type="button" class="btn" onclick="CoverageMap.zoomTo('+feature.bounds+')">Zoom to feature</button><br/>';html+='<p><b>Total discrete samples:&nbsp;</b>';var discreteSampleCount=getCount(feature.attributes,'DISCRETE_SAMPLE_COUNT');html+=discreteSampleCount+'</p>';if((discreteSampleCount>0)&&(CoverageMap.get_date_filter()=='all_time')){var minDate=feature.attributes.MIND.split('-');var maxDate=feature.attributes.MAXD.split('-');html+='<p>Samples taken from&nbsp;'+feature.attributes.MIND
+'&nbsp;to&nbsp;'+feature.attributes.MAXD+'</p>';}
if(CoverageMap.get_data_source()==='all'){html+='<p><b>EPA STORET discrete samples:&nbsp;</b>'+getCount(feature.attributes,'EPA_DISCRETE_SAMPLE_COUNT')+'</br>';html+='<b>USGS NWIS discrete samples:&nbsp;</b>'+getCount(feature.attributes,'NWIS_DISCRETE_SAMPLE_COUNT')+'</p>';}
return html;};var showDetailDialog=function(features,xy){var title;var html='<div id="coverage-map-popup">';var display_by;if(features.length>0){display_by=CoverageMap.get_display_by();title=features[0].attributes[CoverageMapConfig.TITLE_ATTR[display_by]];if(display_by==='counties'){title+=', '+features[0].attributes[CoverageMapConfig.TITLE_ATTR.states];}
html+='<div id="coverage-map-id-title">'+title+'</div>'+formatInfo(features[0]);}
else{html+='<div id="coverage-map-id-title">No Feature info available</div>';}
html+='</div>'
CoverageMap.map.addPopup(new OpenLayers.Popup.FramedCloud("idPopup",CoverageMap.map.getLonLatFromPixel(xy),null,html,null,true));};CoverageMap.map=new OpenLayers.Map(divId,MapUtils.MAP_OPTIONS); var loadingpanel=new OpenLayers.Control.LoadingPanel();CoverageMap.map.addControl(loadingpanel);var baseLayers=[];for(i=0;i<CoverageMap.BASE_LAYERS.length;i++){baseLayers[i]=MapUtils.getLayer(MapUtils.BASE_LAYERS[CoverageMap.BASE_LAYERS[i]],{isBaseLayer:true,transitionEffect:'resize'});}
var i=0;CoverageMap.map.addLayers(baseLayers); CoverageMap.dataLayer=new OpenLayers.Layer.WMS("Data",Config.GEOSERVER_PROXY_ENDPOINT+'wms',{layers:CoverageMapConfig.LAYER_PARAM.states,viewparams:CoverageMapConfig.get_viewparams('all_time','all')},{displayInLayerSwitcher:false,isBaseLayer:false,singleTile:true,visibility:true,opacity:0.75});CoverageMap.map.addLayer(CoverageMap.dataLayer); detailDialogEl.dialog({autoOpen:false});var infoControl=new OpenLayers.Control.WMSGetFeatureInfo({title:"Detail information available by clicking",queryVisible:true,layers:[CoverageMap.dataLayer],infoFormat:'application/vnd.ogc.gml',eventListeners:{beforegetfeatureinfo:function(event){var date_filter=CoverageMap.get_date_filter();var source=CoverageMap.get_data_source();this.vendorParams={viewparams:CoverageMapConfig.get_viewparams(date_filter,source)};},getfeatureinfo:function(event){var features=this.format.read(event.text);showDetailDialog(features,event.xy);}}});CoverageMap.map.addControl(infoControl);var center=new OpenLayers.LonLat(MapUtils.DEFAULT_CENTER.lon,MapUtils.DEFAULT_CENTER.lat);CoverageMap.map.setCenter(center.transform(MapUtils.WGS84_PROJECTION,MapUtils.MERCATOR_PROJECTION));CoverageMap.map.zoomTo(3);infoControl.activate();};CoverageMap.updateDataLayerSLD=function(display_by,date_filter,source){CoverageMap.dataLayer.mergeNewParams({layers:CoverageMapConfig.LAYER_PARAM[display_by],viewparams:CoverageMapConfig.get_viewparams(date_filter,source),sld:encodeURI(CoverageMapConfig.get_sld_param(display_by,date_filter,source))});};CoverageMap.updateLegend=function(imgEl,display_by,date_filter,source){imgEl.attr('src',Config.GEOSERVER_ENDPOINT+'/wms?request=GetLegendGraphic&format=image/png&layer='+CoverageMapConfig.LAYER_PARAM[display_by]+'&legend_options=fontName:Verdana;fontAntiAliasing:true;'+'&sld='+encodeURIComponent(CoverageMapConfig.get_sld_param(display_by,date_filter,source)));};CoverageMap.get_display_by=function(){return $('input[name="display-by"]:checked').val();};CoverageMap.get_date_filter=function(){return $('input[name="date"]:checked').val();};CoverageMap.get_data_source=function(){return $('input[name="data-source"]:checked').val();};